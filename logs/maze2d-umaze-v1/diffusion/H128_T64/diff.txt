diff --git a/.dockerignore b/.dockerignore
deleted file mode 100644
index 8409704..0000000
--- a/.dockerignore
+++ /dev/null
@@ -1,7 +0,0 @@
-*.ipynb_checkpoints
-*__pycache__*
-*.egg-info
-logs/*
-*.img
-*.simg
-wandb
\ No newline at end of file
diff --git a/.gitignore b/.gitignore
deleted file mode 100644
index 1be7720..0000000
--- a/.gitignore
+++ /dev/null
@@ -1,142 +0,0 @@
-bin/
-logs/
-wandb/
-
-fuse.cfg
-
-*.ai
-
-# Generation results
-results/
-
-ray/auth.json
-
-# Byte-compiled / optimized / DLL files
-__pycache__/
-*.py[cod]
-*$py.class
-
-# C extensions
-*.so
-
-# Distribution / packaging
-.Python
-build/
-develop-eggs/
-dist/
-downloads/
-eggs/
-.eggs/
-lib/
-lib64/
-parts/
-sdist/
-var/
-wheels/
-pip-wheel-metadata/
-share/python-wheels/
-*.egg-info/
-.installed.cfg
-*.egg
-MANIFEST
-
-# PyInstaller
-#  Usually these files are written by a python script from a template
-#  before PyInstaller builds the exe, so as to inject date/other infos into it.
-*.manifest
-*.spec
-
-# Installer logs
-pip-log.txt
-pip-delete-this-directory.txt
-
-# Unit test / coverage reports
-htmlcov/
-.tox/
-.nox/
-.coverage
-.coverage.*
-.cache
-nosetests.xml
-coverage.xml
-*.cover
-*.py,cover
-.hypothesis/
-.pytest_cache/
-
-# Translations
-*.mo
-*.pot
-
-# Django stuff:
-*.log
-local_settings.py
-db.sqlite3
-db.sqlite3-journal
-
-# Flask stuff:
-instance/
-.webassets-cache
-
-# Scrapy stuff:
-.scrapy
-
-# Sphinx documentation
-docs/_build/
-
-# PyBuilder
-target/
-
-# Jupyter Notebook
-.ipynb_checkpoints
-
-# IPython
-profile_default/
-ipython_config.py
-
-# pyenv
-.python-version
-
-# pipenv
-#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
-#   However, in case of collaboration, if having platform-specific dependencies or dependencies
-#   having no cross-platform support, pipenv may install dependencies that don't work, or not
-#   install all needed dependencies.
-#Pipfile.lock
-
-# PEP 582; used by e.g. github.com/David-OConnor/pyflow
-__pypackages__/
-
-# Celery stuff
-celerybeat-schedule
-celerybeat.pid
-
-# SageMath parsed files
-*.sage.py
-
-# Environments
-.env
-.venv
-env/
-venv/
-ENV/
-env.bak/
-venv.bak/
-
-# Spyder project settings
-.spyderproject
-.spyproject
-
-# Rope project settings
-.ropeproject
-
-# mkdocs documentation
-/site
-
-# mypy
-.mypy_cache/
-.dmypy.json
-dmypy.json
-
-# Pyre type checker
-.pyre/
diff --git a/LICENSE b/LICENSE
deleted file mode 100644
index 5eda1a0..0000000
--- a/LICENSE
+++ /dev/null
@@ -1,22 +0,0 @@
-MIT License
-
-Copyright (c) 2020 Phil Wang
-Copyright (c) 2022 Michael Janner and Yilun Du
-
-Permission is hereby granted, free of charge, to any person obtaining a copy
-of this software and associated documentation files (the "Software"), to deal
-in the Software without restriction, including without limitation the rights
-to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
-copies of the Software, and to permit persons to whom the Software is
-furnished to do so, subject to the following conditions:
-
-The above copyright notice and this permission notice shall be included in all
-copies or substantial portions of the Software.
-
-THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
-IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
-FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
-AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
-LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
-OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
-SOFTWARE.
diff --git a/azure/Dockerfile b/azure/Dockerfile
deleted file mode 100644
index 1e96d27..0000000
--- a/azure/Dockerfile
+++ /dev/null
@@ -1,95 +0,0 @@
-# We need the CUDA base dockerfile to enable GPU rendering
-# on hosts with GPUs.
-# The image below is a pinned version of nvidia/cuda:9.1-cudnn7-devel-ubuntu16.04 (from Jan 2018)
-# If updating the base image, be sure to test on GPU since it has broken in the past.
-FROM nvidia/cuda:10.1-cudnn7-devel-ubuntu16.04
-
-SHELL ["/bin/bash", "-c"]
-
-##########################################################
-### System dependencies
-##########################################################
-
-RUN apt-get update -q \
-    && DEBIAN_FRONTEND=noninteractive apt-get install -y \
-    cmake \
-    curl \
-    git \
-    libav-tools \
-    libgl1-mesa-dev \
-    libgl1-mesa-glx \
-    libglew-dev \
-    libosmesa6-dev \
-    net-tools \
-    software-properties-common \
-    swig \
-    unzip \
-    vim \
-    wget \
-    xpra \
-    xserver-xorg-dev \
-    zlib1g-dev \
-    && apt-get clean \
-    && rm -rf /var/lib/apt/lists/*
-
-ENV LANG C.UTF-8
-
-COPY ./azure/files/Xdummy /usr/local/bin/Xdummy
-RUN chmod +x /usr/local/bin/Xdummy
-
-# Workaround for https://bugs.launchpad.net/ubuntu/+source/nvidia-graphics-drivers-375/+bug/1674677
-COPY ./azure/files/10_nvidia.json /usr/share/glvnd/egl_vendor.d/10_nvidia.json
-COPY ./environment.yml /opt/environment.yml
-
-ENV LD_LIBRARY_PATH /usr/local/nvidia/lib64:${LD_LIBRARY_PATH}
-
-##########################################################
-### gsutil
-##########################################################
-RUN curl -sSL https://sdk.cloud.google.com | bash
-
-ENV PATH $PATH:/root/google-cloud-sdk/bin
-
-##########################################################
-### MuJoCo
-##########################################################
-# Note: ~ is an alias for /root
-RUN mkdir -p /root/.mujoco \
-    && wget https://www.roboti.us/download/mujoco200_linux.zip -O mujoco.zip \
-    && unzip mujoco.zip -d /root/.mujoco \
-    && rm mujoco.zip
-RUN mkdir -p /root/.mujoco \
-    && wget https://www.roboti.us/download/mjpro150_linux.zip -O mujoco.zip \
-    && unzip mujoco.zip -d /root/.mujoco \
-    && rm mujoco.zip
-RUN ln -s /root/.mujoco/mujoco200_linux /root/.mujoco/mujoco200
-ENV LD_LIBRARY_PATH /root/.mujoco/mjpro150/bin:${LD_LIBRARY_PATH}
-ENV LD_LIBRARY_PATH /root/.mujoco/mujoco200/bin:${LD_LIBRARY_PATH}
-ENV LD_LIBRARY_PATH /root/.mujoco/mujoco200_linux/bin:${LD_LIBRARY_PATH}
-COPY ./azure/files/mjkey.txt /root/.mujoco
-
-##########################################################
-### Example Python Installation
-##########################################################
-ENV PATH /opt/conda/bin:$PATH
-RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh && \
-    /bin/bash /tmp/miniconda.sh -b -p /opt/conda && \
-    rm /tmp/miniconda.sh && \
-    ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
-    echo ". /opt/conda/etc/profile.d/conda.sh" >> /etc/bash.bashrc
-
-RUN conda update -y --name base conda && conda clean --all -y
-
-RUN git config --global url."https://".insteadOf git://
-RUN conda env create -f /opt/environment.yml
-ENV PATH /opt/conda/envs/diffusion/bin:$PATH
-
-##########################################################
-### gym sometimes has this patchelf issue
-##########################################################
-RUN curl -o /usr/local/bin/patchelf https://s3-us-west-2.amazonaws.com/openai-sci-artifacts/manual-builds/patchelf_0.9_amd64.elf \
-    && chmod +x /usr/local/bin/patchelf
-# RUN pip install gym[all]==0.12.5
-
-RUN echo "source activate /opt/conda/envs/diffusion && export PYTHONPATH=$PYTHONPATH:/home/code && export CUDA_VISIBLE_DEVICES=0" >> ~/.bashrc
-RUN source ~/.bashrc
diff --git a/azure/config.py b/azure/config.py
deleted file mode 100644
index 9ebda44..0000000
--- a/azure/config.py
+++ /dev/null
@@ -1,52 +0,0 @@
-import os
-
-def get_docker_username():
-   import subprocess
-   import shlex
-   ps = subprocess.Popen(shlex.split('docker info'), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
-   output = subprocess.check_output(shlex.split("sed '/Username:/!d;s/.* //'"), stdin=ps.stdout)
-   username = output.decode('utf-8').replace('\n', '')
-   print(f'[ azure/config ] Grabbed username from `docker info`: {username}')
-   return username
-
-## /path/to/diffuser/azure
-CWD = os.path.dirname(__file__)
-## /path/to/diffuser
-MODULE_PATH = os.path.dirname(CWD)
-
-CODE_DIRS_TO_MOUNT = [
-]
-NON_CODE_DIRS_TO_MOUNT = [
-   dict(
-      local_dir=MODULE_PATH,
-      mount_point='/home/code',
-   ),
-]
-REMOTE_DIRS_TO_MOUNT = [
-    dict(
-        local_dir='/doodad_tmp/',
-        mount_point='/doodad_tmp/',
-    ),
-]
-LOCAL_LOG_DIR = '/tmp'
-
-DEFAULT_AZURE_GPU_MODEL = 'nvidia-tesla-t4'
-DEFAULT_AZURE_INSTANCE_TYPE = 'Standard_DS1_v2'
-DEFAULT_AZURE_REGION = 'eastus'
-DEFAULT_AZURE_RESOURCE_GROUP = 'diff'
-DEFAULT_AZURE_VM_NAME = 'diff-vm'
-DEFAULT_AZURE_VM_PASSWORD = 'Azure1'
-
-DOCKER_USERNAME = os.environ.get('DOCKER_USERNAME', get_docker_username())
-DEFAULT_DOCKER = f'docker.io/{DOCKER_USERNAME}/diffuser:latest'
-
-print(f'[ azure/config ] Local dir: {MODULE_PATH}')
-print(f'[ azure/config ] Default GPU model: {DEFAULT_AZURE_GPU_MODEL}')
-print(f'[ azure/config ] Default Docker image: {DEFAULT_DOCKER}')
-
-AZ_SUB_ID = os.environ['AZURE_SUBSCRIPTION_ID']
-AZ_CLIENT_ID = os.environ['AZURE_CLIENT_ID']
-AZ_TENANT_ID = os.environ['AZURE_TENANT_ID']
-AZ_SECRET = os.environ['AZURE_CLIENT_SECRET']
-AZ_CONTAINER = os.environ['AZURE_STORAGE_CONTAINER']
-AZ_CONN_STR = os.environ['AZURE_STORAGE_CONNECTION_STRING']
diff --git a/azure/download.sh b/azure/download.sh
deleted file mode 100644
index ce7baef..0000000
--- a/azure/download.sh
+++ /dev/null
@@ -1,7 +0,0 @@
-DOWNLOAD_DIR=bin
-mkdir $DOWNLOAD_DIR
-wget https://aka.ms/downloadazcopy-v10-linux -O $DOWNLOAD_DIR/download.tar.gz
-tar -xvf $DOWNLOAD_DIR/download.tar.gz --one-top-level=$DOWNLOAD_DIR
-mv $DOWNLOAD_DIR/*/azcopy $DOWNLOAD_DIR
-rm $DOWNLOAD_DIR/download.tar.gz
-rm -r $DOWNLOAD_DIR/azcopy_linux*
diff --git a/azure/files/10_nvidia.json b/azure/files/10_nvidia.json
deleted file mode 100644
index 2bfcca0..0000000
--- a/azure/files/10_nvidia.json
+++ /dev/null
@@ -1,6 +0,0 @@
-{
-    "file_format_version" : "1.0.0",
-    "ICD" : {
-        "library_path" : "libEGL_nvidia.so.0"
-    }
-}
diff --git a/azure/files/Xdummy b/azure/files/Xdummy
deleted file mode 100644
index 1ffddfa..0000000
--- a/azure/files/Xdummy
+++ /dev/null
@@ -1,1955 +0,0 @@
-#!/bin/sh
-# ----------------------------------------------------------------------
-#    Copyright (C) 2005-2011 Karl J. Runge <runge@karlrunge.com> 
-#    All rights reserved.
-# 
-# This file is part of Xdummy.
-# 
-# Xdummy is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or (at
-# your option) any later version.
-# 
-# Xdummy is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-# 
-# You should have received a copy of the GNU General Public License
-# along with Xdummy; if not, write to the Free Software
-# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA
-# or see <http://www.gnu.org/licenses/>.
-# ----------------------------------------------------------------------
-# 
-# 
-# Xdummy: an LD_PRELOAD hack to run a stock Xorg(1) or XFree86(1) server
-# with the "dummy" video driver to make it avoid Linux VT switching, etc.
-#
-# Run "Xdummy -help" for more info.
-#
-install=""
-uninstall=""
-runit=1
-prconf=""
-notweak=""
-root=""
-nosudo=""
-xserver=""
-geom=""
-nomodelines=""
-depth=""
-debug=""
-strace=""
-cmdline_config=""
-
-PATH=$PATH:/bin:/usr/bin
-export PATH
-
-program=`basename "$0"`
-
-help () {
-	${PAGER:-more} << END
-$program:
-
-    A hack to run a stock Xorg(1) or XFree86(1) X server with the "dummy"
-    (RAM-only framebuffer) video driver such that it AVOIDS the Linux VT
-    switching, opening device files in /dev, keyboard and mouse conflicts,
-    and other problems associated with the normal use of "dummy".
-
-    In other words, it tries to make Xorg/XFree86 with the "dummy"
-    device driver act more like Xvfb(1).
-
-    The primary motivation for the Xdummy script is to provide a virtual X
-    server for x11vnc but with more features than Xvfb (or Xvnc); however
-    it could be used for other reasons (e.g. better automated testing
-    than with Xvfb.)  One nice thing is the dummy server supports RANDR
-    dynamic resizing while Xvfb does not.
-
-    So, for example, x11vnc+Xdummy terminal services are a little better
-    than x11vnc+Xvfb.
-
-    To achieve this, while running the real Xserver $program intercepts
-    system and library calls via the LD_PRELOAD method and modifies
-    the behavior to make it work correctly (e.g. avoid the VT stuff.)
-    LD_PRELOAD tricks are usually "clever hacks" and so might not work
-    in all situations or break when something changes.
-
-    WARNING: Take care in using Xdummy, although it never has it is
-    possible that it could damage hardware.  One can use the -prconf
-    option to have it print out the xorg.conf config that it would use
-    and then inspect it carefully before actually using it.
-
-    This program no longer needs to be run as root as of 12/2009.
-    However, if there are problems for certain situations (usually older
-    servers) it may perform better if run as root (use the -root option.)
-    When running as root remember the previous paragraph and that Xdummy
-    comes without any warranty.
-
-    gcc/cc and other build tools are required for this script to be able
-    to compile the LD_PRELOAD shared object.  Be sure they are installed
-    on the system.  See -install and -uninstall described below.
-
-    Your Linux distribution may not install the dummy driver by default,
-    e.g:
-
-        /usr/lib/xorg/modules/drivers/dummy_drv.so
-    
-    some have it in a package named xserver-xorg-video-dummy you that
-    need to install.
-
-Usage:
-
-	$program <${program}-args> <Xserver-args>
-
-	(actually, the arguments can be supplied in any order.)
-
-Examples:
-
-	$program -install
-
-	$program :1
-
-	$program -debug :1
-
-	$program -tmpdir ~/mytmp :1 -nolisten tcp
-
-startx example:
-
-	startx -e bash -- $program :2 -depth 16
-
-	(if startx needs to be run as root, you can su(1) to a normal
-	user in the bash shell and then launch ~/.xinitrc or ~/.xsession,
-	gnome-session, startkde, startxfce4, etc.)
-
-xdm example:
-
-	xdm -config /usr/local/dummy/xdm-config -nodaemon
-
-	where the xdm-config file has line:
-
-	     DisplayManager.servers:         /usr/local/dummy/Xservers
-
-	and /usr/local/dummy/Xservers has lines:
-
-	     :1 local /usr/local/dummy/Xdummy :1 -debug
-	     :2 local /usr/local/dummy/Xdummy :2 -debug
-
-        (-debug is optional)
-
-gdm/kdm example:
-
-	TBD.
-
-Config file:
-
-	If the file $program.cfg exists it will be sourced as shell
-	commands.  Usually one will set some variables this way.
-	To disable sourcing, supply -nocfg or set XDUMMY_NOCFG=1.
-
-Root permission and x11vnc:
-
-	Update: as of 12/2009 this program no longer must be run as root.
-	So try it as non-root before running it as root and/or the
-	following schemes.
-
-	In some circumstances X server program may need to be run as root.
-	If so, one could run x11vnc as root with -unixpw (it switches
-	to the user that logs in) and that may be OK, some other ideas:
-
-	- add this to sudo via visudo:
-
-		ALL ALL = NOPASSWD: /usr/local/bin/Xdummy
-
-	- use this little suid wrapper:
-/* 
- * xdummy.c
- *
-   cc -o ./xdummy xdummy.c
-   sudo cp ./xdummy /usr/local/bin/xdummy
-   sudo chown root:root /usr/local/bin/xdummy
-   sudo chmod u+s /usr/local/bin/xdummy
- *
- */
-#include <unistd.h>
-#include <stdlib.h>
-#include <sys/types.h>
-#include <stdio.h>
-
-int main (int argc, char *argv[]) {
-	extern char **environ;
-	char str[100];
-	sprintf(str, "XDUMMY_UID=%d", (int) getuid());
-	putenv(str);
-	setuid(0);  
-	setgid(0);
-	execv("/usr/local/bin/Xdummy", argv); 
-	exit(1);
-	return 1;
-}
-
-
-Options:
-
-    ${program}-args:
-
-	-install	Compile the LD_PRELOAD shared object and install it
-			next to the $program script file as:
-
-			  $0.so
-
-			When that file exists it is used as the LD_PRELOAD
-			shared object without recompiling.  Otherwise,
-			each time $program is run the LD_PRELOAD shared
-			object is compiled as a file in /tmp (or -tmpdir)
-
-			If you set the environment variable
-			INTERPOSE_GETUID=1 when building, then when
-			$program is run as an ordinary user, the shared
-			object will interpose getuid() calls and pretend
-			to be root.  Otherwise it doesn't pretend to
-			be root.
-
-			You can also set the CFLAGS environment variable
-			to anything else you want on the compile cmdline.
-
-	-uninstall	Remove the file:
-
-			  $0.so
-
-			The LD_PRELOAD shared object will then be compiled
-			each time this program is run.
-
-	The X server is not started under -install, -uninstall, or -prconf.
-
-
-	:N		The DISPLAY (e.g. :15) is often the first
-			argument.  It is passed to the real X server and
-			also used by the Xdummy script as an identifier.
-
-	-geom geom1[,geom2...]	Take the geometry (e.g. 1024x768) or list
-			of geometries and insert them into the Screen
-			section of the tweaked X server config file.
-			Use this to have a different geometry than the
-			one(s) in the system config file.
-
-			The option -geometry can be used instead of -geom;
-			x11vnc calls Xdummy and Xvfb this way.
-
-	-nomodelines	When you specify -geom/-geometry, $program will
-			create Modelines for each geometry and put them
-			in the Monitor section.  If you do not want this
-			then supply -nomodelines.
-
-	-depth n	Use pixel color depth n (e.g. 8, 16, or 24). This
-			makes sure the X config file has a Screen.Display
-			subsection of this depth.  Note this option is
-			ALSO passed to the X server.
-
-	-DEPTH n	Same as -depth, except not passed to X server.
-
-	-tmpdir dir	Specify a temporary directory, owned by you and
-			only writable by you.  This is used in place of
-			/tmp/Xdummy.\$USER/..  to place the $program.so
-			shared object, tweaked config files, etc.
-
-	-nonroot	Run in non-root mode (working 12/2009, now default)
-
-	-root		Run as root (may still be needed in some
-			environments.)  Same as XDUMMY_RUN_AS_ROOT=1.
-
-	-nosudo		Do not try to use sudo(1) when re-running as root,
-			use su(1) instead.
-
-	-xserver path	Specify the path to the Xserver to use.  Default
-			is to try "Xorg" first and then "XFree86".  If
-			those are not in \$PATH, it tries these locations:
-				/usr/bin/Xorg
-				/usr/X11R6/bin/Xorg
-				/usr/X11R6/bin/XFree86
-
-	-n		Do not run the command to start the X server,
-			just show the command that $program would run.
-			The LD_PRELOAD shared object will be built,
-			if needed.  Also note any XDUMMY* environment
-			variables that need to be set.
-
-	-prconf		Print, to stdout, the tweaked Xorg/XFree86
-			config file (-config and -xf86config server
-			options, respectively.)  The Xserver is not
-			started.
-
-	-notweak	Do not tweak (modify) the Xorg/XFree86 config file
-			(system or server command line) at all.  The -geom
-			and similar config file modifications are ignored.
-
-			It is up to you to make sure it is a working
-			config file (e.g. "dummy" driver, etc.)
-			Perhaps you want to use a file based on the
-			-prconf output.
-
-	-nocfg		Do not try to source $program.cfg even if it
-			exists.  Same as setting XDUMMY_NOCFG=1.
-
-	-debug		Extra debugging output.
-
-	-strace		strace(1) the Xserver process (for troubleshooting.)
-	-ltrace		ltrace(1) instead of strace (can be slow.)
-
-	-h, -help	Print out this help.
-
-
-    Xserver-args:
-
-	Most of the Xorg and XFree86 options will work and are simply
-	passed along if you supply them.  Important ones that may be
-	supplied if missing:
-
-	:N		X Display number for server to use.
-
-	vtNN		Linux virtual terminal (VT) to use (a VT is currently
-			still used, just not switched to and from.)
-
-	-config file		Driver "dummy" tweaked config file, a
-	-xf86config file	number of settings are tweaked besides Driver.
-
-	If -config/-xf86config is not given, the system one
-	(e.g. /etc/X11/xorg.conf) is used.  If the system one cannot be
-	found, a built-in one is used.	Any settings in the config file
-	that are not consistent with "dummy" mode will be overwritten
-	(unless -notweak is specified.)
-
-	Use -config xdummy-builtin to force usage of the builtin config.
-
-	If "file" is only a basename (e.g. "xorg.dummy.conf") with no /'s,
-	then no tweaking of it is done: the X server will look for that
-	basename via its normal search algorithm.  If the found file does
-	not refer to the "dummy" driver, etc, then the X server will fail.
-
-	You can set the env. var. XDUMMY_EXTRA_SERVER_ARGS to hold some
-	extra Xserver-args too. (Useful for cfg file.)
-
-Notes:
-
-    The Xorg/XFree86 "dummy" driver is currently undocumented.  It works
-    well in this mode, but it is evidently not intended for end-users.
-    So it could be removed or broken at any time.
-
-    If the display Xserver-arg (e.g. :1) is not given, or ":" is given
-    that indicates $program should try to find a free one (based on
-    tcp ports.)
-
-    If the display virtual terminal, VT, (e.g. vt9) is not given that
-    indicates $program should try to find a free one (or guess a high one.) 
-    
-    This program is not completely secure WRT files in /tmp (but it tries
-    to a good degree.)  Better is to use the -tmpdir option to supply a
-    directory only writable by you.  Even better is to get rid of users
-    on the local machine you do not trust :-)
-
-    Set XDUMMY_SET_XV=1 to turn on debugging output for this script.
-
-END
-}
-
-warn() {
-	echo "$*" 1>&2
-}
-
-if [ "X$XDUMMY_SET_XV" != "X" ]; then
-	set -xv
-fi
-
-if [ "X$XDUMMY_UID" = "X" ]; then
-	XDUMMY_UID=`id -u`
-	export XDUMMY_UID
-fi
-if [ "X$XDUMMY_UID" = "X0" ]; then
-	if [ "X$SUDO_UID" != "X" ]; then
-		XDUMMY_UID=$SUDO_UID
-		export XDUMMY_UID
-	fi
-fi
-
-# check if root=1 first:
-#
-if [ "X$XDUMMY_RUN_AS_ROOT" = "X1" ]; then
-	root=1
-fi
-for arg in $*
-do
-	if [ "X$arg" = "X-nonroot" ]; then
-		root=""
-	elif [ "X$arg" = "X-root" ]; then
-		root=1
-	elif [ "X$arg" = "X-nocfg" ]; then
-		XDUMMY_NOCFG=1
-		export XDUMMY_NOCFG
-	fi
-done
-
-if [ "X$XDUMMY_NOCFG" = "X" -a -f "$0.cfg" ]; then
-	. "$0.cfg"
-fi
-
-# See if it really needs to be run as root:
-#
-if [ "X$XDUMMY_SU_EXEC" = "X" -a "X$root" = "X1" -a "X`id -u`" != "X0"  ]; then
-	# this is to prevent infinite loop in case su/sudo doesn't work:
-	XDUMMY_SU_EXEC=1
-	export XDUMMY_SU_EXEC
-
-	dosu=1
-	nosudo=""
-
-	for arg in $*
-	do
-		if [ "X$arg" = "X-nonroot" ]; then
-			dosu=""
-		elif [ "X$arg" = "X-nosudo" ]; then
-			nosudo="1"
-		elif [ "X$arg" = "X-help" ]; then
-			dosu=""
-		elif [ "X$arg" = "X-h" ]; then
-			dosu=""
-		elif [ "X$arg" = "X-install" ]; then
-			dosu=""
-		elif [ "X$arg" = "X-uninstall" ]; then
-			dosu=""
-		elif [ "X$arg" = "X-n" ]; then
-			dosu=""
-		elif [ "X$arg" = "X-prconf" ]; then
-			dosu=""
-		fi
-	done
-	if [ $dosu ]; then
-		# we need to restart it with su/sudo:
-		if type sudo > /dev/null 2>&1; then
-			:
-		else
-			nosudo=1
-		fi
-		if [ "X$nosudo" = "X" ]; then
-			warn "$program: supply the sudo password to restart as root:"
-			if [ "X$XDUMMY_UID" != "X" ]; then
-				exec sudo $0 -uid $XDUMMY_UID "$@"
-			else
-				exec sudo $0 "$@"
-			fi
-		else
-			warn "$program: supply the root password to restart as root:"
-			if [ "X$XDUMMY_UID" != "X" ]; then
-				exec su -c "$0 -uid $XDUMMY_UID $*"
-			else
-				exec su -c "$0 $*"
-			fi
-		fi
-		# DONE:
-		exit
-	fi
-fi
-
-# This will hold the X display, e.g. :20
-#
-disp=""
-args=""
-cmdline_config=""
-
-# Process Xdummy args:
-#
-while [ "X$1" != "X" ]
-do
-    if [ "X$1" = "X-config" -o "X$1" = "X-xf86config" ]; then
-    	cmdline_config="$2"
-    fi
-    case $1 in 
-	":"*)	disp=$1
-                ;;
-	"-install") install=1; runit=""
-                ;;
-	"-uninstall") uninstall=1; runit=""
-                ;;
-	"-n")  runit=""
-                ;;
-	"-no") runit=""
-                ;;
-	"-norun") runit=""
-                ;;
-	"-prconf") prconf=1; runit=""
-                ;;
-	"-notweak") notweak=1
-                ;;
-	"-noconf")  notweak=1
-                ;;
-	"-nonroot") root=""
-                ;;
-	"-root")    root=1
-                ;;
-	"-nosudo") nosudo=1
-                ;;
-	"-xserver") xserver="$2"; shift
-                ;;
-	"-uid") XDUMMY_UID="$2"; shift
-		export XDUMMY_UID
-                ;;
-	"-geom")     geom="$2"; shift
-                ;;
-	"-geometry") geom="$2"; shift
-                ;;
-	"-nomodelines") nomodelines=1
-                ;;
-	"-depth") depth="$2"; args="$args -depth $2";
-		  shift
-                ;;
-	"-DEPTH") depth="$2"; shift
-                ;;
-	"-tmpdir") XDUMMY_TMPDIR="$2"; shift
-                ;;
-	"-debug")   debug=1
-                ;;
-	"-nocfg") :
-                ;;
-	"-nodebug") debug=""
-                ;;
-	"-strace") strace=1
-                ;;
-	"-ltrace") strace=2
-                ;;
-	"-h")	 help; exit 0
-                ;;
-	"-help") help; exit 0
-                ;;
-	*)	args="$args $1"
-                ;;
-    esac
-    shift
-done
-
-if [ "X$XDUMMY_EXTRA_SERVER_ARGS" != "X" ]; then
-	args="$args $XDUMMY_EXTRA_SERVER_ARGS"
-fi
-
-# Try to get a username for use in our tmp directory, etc.
-#
-user=""
-if [ X`id -u` = "X0"  ]; then
-	user=root	# this will also be used below for id=0
-elif [ "X$USER" != "X" ]; then
-	user=$USER
-elif [ "X$LOGNAME" != "X" ]; then
-	user=$LOGNAME
-fi
-
-# Keep trying...
-#
-if [ "X$user" = "X" ]; then
-	user=`whoami 2>/dev/null`
-fi
-if [ "X$user" = "X" ]; then
-	user=`basename "$HOME"`
-fi
-if [ "X$user" = "X" -o "X$user" = "X." ]; then
-	user="u$$"
-fi
-
-if [ "X$debug" = "X1" -a "X$runit" != "X" ]; then
-	echo ""
-	echo "/usr/bin/env:"
-	env | egrep -v '^(LS_COLORS|TERMCAP)' | sort
-	echo ""
-fi
-
-# Function to compile the LD_PRELOAD shared object:
-#
-make_so() {
-	# extract code embedded in this script into a tmp C file: 
-	n1=`grep -n '^#code_begin' $0 | head -1 | awk -F: '{print $1}'`
-	n2=`grep -n '^#code_end'   $0 | head -1 | awk -F: '{print $1}'`
-	n1=`expr $n1 + 1`
-	dn=`expr $n2 - $n1`
-
-	tmp=$tdir/Xdummy.$RANDOM$$.c
-	rm -f $tmp
-	if [ -e $tmp -o -h $tmp ]; then
-		warn "$tmp still exists."
-		exit 1
-	fi
-	touch $tmp || exit 1
-	tail -n +$n1 $0 | head -n $dn > $tmp
-
-	# compile it to Xdummy.so:
-	if [ -f "$SO" ]; then
-		mv $SO $SO.$$
-		rm -f $SO.$$
-	fi
-	rm -f $SO
-	touch $SO
-	if [ ! -f "$SO" ]; then
-		SO=$tdir/Xdummy.$user.so
-		warn "warning switching LD_PRELOAD shared object to: $SO"
-	fi
-
-	if [ -f "$SO" ]; then
-		mv $SO $SO.$$
-		rm -f $SO.$$
-	fi
-	rm -f $SO
-
-	# we assume gcc:
-	if [ "X$INTERPOSE_GETUID" = "X1" ]; then
-		CFLAGS="$CFLAGS -DINTERPOSE_GETUID"
-	fi
-	echo "$program:" cc -shared -fPIC $CFLAGS -o $SO $tmp -ldl
-                         cc -shared -fPIC $CFLAGS -o $SO $tmp -ldl
-	rc=$?
-	rm -f $tmp
-	if [ $rc != 0 ]; then
-		warn "$program: cannot build $SO"
-		exit 1
-	fi
-	if [ "X$debug" != "X" -o "X$install" != "X" ]; then
-		warn "$program: created  $SO"
-		ls -l "$SO"
-	fi
-}
-
-# Set tdir to tmp dir for make_so():
-if [ "X$XDUMMY_TMPDIR" != "X" ]; then
-	tdir=$XDUMMY_TMPDIR
-	mkdir -p $tdir
-else
-	tdir="/tmp"
-fi
-
-# Handle -install/-uninstall case:
-SO=$0.so
-if [ "X$install" != "X" -o "X$uninstall" != "X" ]; then
-	if [ -e "$SO" -o -h "$SO" ]; then
-		warn "$program: removing $SO"
-	fi
-	if [ -f "$SO" ]; then
-		mv $SO $SO.$$
-		rm -f $SO.$$
-	fi
-	rm -f $SO
-	if [ -e "$SO" -o -h "$SO" ]; then
-		warn "warning: $SO still exists."
-		exit 1
-	fi
-	if [ $install ]; then
-		make_so
-		if [ ! -f "$SO" ]; then
-			exit 1
-		fi
-	fi
-	exit 0
-fi
-
-# We need a tmp directory for the .so, tweaked config file, and for
-# redirecting filenames we cannot create (under -nonroot)
-#
-tack=""
-if [ "X$XDUMMY_TMPDIR" = "X" ]; then
-	XDUMMY_TMPDIR="/tmp/Xdummy.$user"
-
-	# try to tack on a unique subdir (display number or pid)
-	# to allow multiple instances
-	#
-	if [ "X$disp" != "X" ]; then
-		t0=$disp
-	else
-		t0=$1
-	fi
-	tack=`echo "$t0" | sed -e 's/^.*://'`
-	if echo "$tack" | grep '^[0-9][0-9]*$' > /dev/null; then
-		:
-	else
-		tack=$$
-	fi
-	if [ "X$tack" != "X" ]; then
-		XDUMMY_TMPDIR="$XDUMMY_TMPDIR/$tack"
-	fi
-fi
-
-tmp=$XDUMMY_TMPDIR
-if echo "$tmp" | grep '^/tmp' > /dev/null; then
-	if [ "X$tmp" != "X/tmp" -a "X$tmp" != "X/tmp/" ]; then
-		# clean this subdir of /tmp out, otherwise leave it...
-		rm -rf $XDUMMY_TMPDIR
-		if [ -e $XDUMMY_TMPDIR ]; then
-			warn "$XDUMMY_TMPDIR still exists"
-			exit 1
-		fi
-	fi
-fi
-
-mkdir -p $XDUMMY_TMPDIR
-chmod 700 $XDUMMY_TMPDIR
-if [ "X$tack" != "X" ]; then
-	chmod 700 `dirname "$XDUMMY_TMPDIR"` 2>/dev/null
-fi
-
-# See if we can write something there:
-#
-tfile="$XDUMMY_TMPDIR/test.file"
-touch $tfile
-if [ ! -f "$tfile" ]; then
-	XDUMMY_TMPDIR="/tmp/Xdummy.$$.$USER"
-	warn "warning: setting tmpdir to $XDUMMY_TMPDIR ..."
-	rm -rf $XDUMMY_TMPDIR || exit 1
-	mkdir -p $XDUMMY_TMPDIR || exit 1
-fi
-rm -f $tfile
-
-export XDUMMY_TMPDIR
-
-# Compile the LD_PRELOAD shared object if needed (needs XDUMMY_TMPDIR)
-#
-if [ ! -f "$SO" ]; then
-	SO="$XDUMMY_TMPDIR/Xdummy.so"
-	make_so
-fi
-
-# Decide which X server to use:
-#
-if [ "X$xserver" = "X" ]; then
-	if type Xorg >/dev/null 2>&1; then
-		xserver="Xorg"
-	elif type XFree86 >/dev/null 2>&1; then
-		xserver="XFree86"
-	elif -x /usr/bin/Xorg; then
-		xserver="/usr/bin/Xorg"
-	elif -x /usr/X11R6/bin/Xorg; then
-		xserver="/usr/X11R6/bin/Xorg"
-	elif -x /usr/X11R6/bin/XFree86; then
-		xserver="/usr/X11R6/bin/XFree86"
-	fi
-	if [ "X$xserver" = "X" ]; then
-		# just let it fail below.
-		xserver="/usr/bin/Xorg"
-		warn "$program: cannot locate a stock Xserver... assuming $xserver"
-	fi
-fi
-
-# See if the binary is suid or not readable under -nonroot mode:
-#
-if [ "X$BASH_VERSION" != "X" ]; then
-	xserver_path=`type -p $xserver 2>/dev/null`
-else
-	xserver_path=`type $xserver 2>/dev/null | awk '{print $NF}'`
-fi
-if [ -e "$xserver_path" -a "X$root" = "X" -a "X$runit" != "X" ]; then
-	if [ ! -r $xserver_path -o -u $xserver_path -o -g $xserver_path ]; then
-		# XXX not quite correct with rm -rf $XDUMMY_TMPDIR ...
-		# we keep on a filesystem we know root can write to.
-		base=`basename "$xserver_path"`
-		new="/tmp/$base.$user.bin"
-		if [ -e $new ]; then
-			snew=`ls -l $new          | awk '{print $5}' | grep '^[0-9][0-9]*$'`
-			sold=`ls -l $xserver_path | awk '{print $5}' | grep '^[0-9][0-9]*$'`
-			if [ "X$snew" != "X" -a "X$sold" != "X" -a "X$sold" != "X$snew" ]; then
-				warn "removing different sized copy:"
-				ls -l $new $xserver_path
-				rm -f $new
-			fi
-		fi
-		if [ ! -e $new -o ! -s $new ]; then
-			rm -f $new
-			touch $new || exit 1
-			chmod 700 $new || exit 1
-			if [ ! -r $xserver_path ]; then
-				warn ""
-				warn "NEED TO COPY UNREADABLE $xserver_path to $new as root:"
-				warn ""
-				ls -l $xserver_path 1>&2
-				warn ""
-				warn "This only needs to be done once:"
-				warn "    cat $xserver_path > $new"
-				warn ""
-				nos=$nosudo
-				if type sudo > /dev/null 2>&1; then
-					:
-				else
-					nos=1
-				fi
-				if [ "X$nos" = "X1" ]; then
-					warn "Please supply root passwd to 'su -c'"
-					su -c "cat $xserver_path > $new"
-				else
-					warn "Please supply the sudo passwd if asked:"
-					sudo /bin/sh -c "cat $xserver_path > $new"
-				fi
-			else
-				warn ""
-				warn "COPYING SETUID $xserver_path to $new"
-				warn ""
-				ls -l $xserver_path 1>&2
-				warn ""
-				cat $xserver_path > $new
-			fi
-			ls -l $new
-			if [ -s $new ]; then
-				:
-			else
-				rm -f $new
-				ls -l $new
-				exit 1
-			fi
-			warn ""
-			warn "Please restart Xdummy now."
-			exit 0
-		fi
-		if [ ! -O $new ]; then
-			warn "file \"$new\" not owned by us!"
-			ls -l $new
-			exit 1
-		fi
-		xserver=$new
-	fi 
-fi
-
-# Work out display:
-#
-if [ "X$disp" != "X" ]; then
-	:
-elif [ "X$1" != "X" ]; then
-	if echo "$1" | grep '^:[0-9]' > /dev/null; then
-		disp=$1
-		shift
-	elif [ "X$1" = "X:" ]; then
-		# ":" means for us to find one.
-		shift
-	fi
-fi
-if [ "X$disp" = "X" -o "X$disp" = "X:" ]; then
-	# try to find an open display port:
-	# (tcp outdated...)
-	ports=`netstat -ant | grep LISTEN | awk '{print $4}' | sed -e 's/^.*://'`
-	n=0
-	while [ $n -le 20 ]
-	do
-		port=`printf "60%02d" $n`
-		if echo "$ports" | grep "^${port}\$" > /dev/null; then
-			:
-		else
-			disp=":$n"
-			warn "$program: auto-selected DISPLAY $disp"
-			break	
-		fi
-		n=`expr $n + 1`
-	done
-fi
-
-# Work out which vt to use, try to find/guess an open one if necessary.
-#
-vt=""
-for arg in $*
-do
-	if echo "$arg" | grep '^vt' > /dev/null; then
-		vt=$arg
-		break
-	fi
-done
-if [ "X$vt" = "X" ]; then
-	if [ "X$user" = "Xroot" ]; then
-		# root can user fuser(1) to see if it is in use:
-		if type fuser >/dev/null 2>&1; then
-			# try /dev/tty17 thru /dev/tty32
-			n=17
-			while [ $n -le 32 ]
-			do
-				dev="/dev/tty$n"
-				if fuser $dev >/dev/null 2>&1; then
-					:
-				else
-					vt="vt$n"
-					warn "$program: auto-selected VT $vt => $dev"
-					break
-				fi
-				n=`expr $n + 1`
-			done
-		fi
-	fi
-	if [ "X$vt" = "X" ]; then
-		# take a wild guess...
-		vt=vt16
-		warn "$program: selected fallback VT $vt"
-	fi
-else
-	vt=""
-fi
-
-# Decide flavor of Xserver:
-#
-stype=`basename "$xserver"`
-if echo "$stype" | grep -i xfree86 > /dev/null; then
-	stype=xfree86
-else
-	stype=xorg
-fi
-
-tweak_config() {
-    in="$1"
-    config2="$XDUMMY_TMPDIR/xdummy_modified_xconfig.conf"
-    if [ "X$disp" != "X" ]; then
-    	d=`echo "$disp" | sed -e 's,/,,g' -e 's/:/_/g'`
-	config2="$config2$d"
-    fi
-    
-    # perl script to tweak the config file... add/delete options, etc.
-    #
-    env XDUMMY_GEOM=$geom \
-        XDUMMY_DEPTH=$depth \
-        XDUMMY_NOMODELINES=$nomodelines \
-        perl > $config2 < $in -e '
-    $n = 0;
-    $geom  = $ENV{XDUMMY_GEOM};
-    $depth = $ENV{XDUMMY_DEPTH};
-    $nomodelines = $ENV{XDUMMY_NOMODELINES};
-    $mode_str = "";
-    $videoram = "24000";
-    $HorizSync   = "30.0 - 130.0";
-    $VertRefresh = "50.0 - 250.0";
-    if ($geom ne "") {
-    	my $tmp = "";
-	foreach $g (split(/,/, $geom)) {
-		$tmp .= "\"$g\" ";
-		if (!$nomodelines && $g =~ /(\d+)x(\d+)/) {
-			my $w = $1;
-			my $h = $2;
-			$mode_str .= "  Modeline \"$g\" ";
-			my $dot = sprintf("%.2f", $w * $h * 70 * 1.e-6);
-			$mode_str .= $dot;
-			$mode_str .= " " . $w;
-			$mode_str .= " " . int(1.02 * $w);
-			$mode_str .= " " . int(1.10 * $w);
-			$mode_str .= " " . int(1.20 * $w);
-			$mode_str .= " " . $h;
-			$mode_str .= " " . int($h + 1);
-			$mode_str .= " " . int($h + 3);
-			$mode_str .= " " . int($h + 20);
-			$mode_str .= "\n";
-		}
-	}
-	$tmp =~ s/\s*$//;
-	$geom = $tmp;
-    }
-    while (<>) {
-	if ($ENV{XDUMMY_NOTWEAK}) {
-		print $_;
-		next;
-	}
-	$n++;
-	if (/^\s*#/) {
-		# pass comments straight thru
-		print;
-		next;
-	}
-	if (/^\s*Section\s+(\S+)/i) {
-		# start of Section
-		$sect = $1;
-		$sect =~ s/\W//g;
-		$sect =~ y/A-Z/a-z/;
-		$sects{$sect} = 1;
-		print;
-		next;
-	}
-	if (/^\s*EndSection/i) {
-		# end of Section
-		if ($sect eq "serverflags") {
-			if (!$got_DontVTSwitch) {
-				print "  ##Xdummy:##\n";
-				print "  Option \"DontVTSwitch\" \"true\"\n";
-			}
-			if (!$got_AllowMouseOpenFail) {
-				print "  ##Xdummy:##\n";
-				print "  Option \"AllowMouseOpenFail\" \"true\"\n";
-			}
-			if (!$got_PciForceNone) {
-				print "  ##Xdummy:##\n";
-				print "  Option \"PciForceNone\" \"true\"\n";
-			}
-		} elsif ($sect eq "device") {
-			if (!$got_Driver) {
-				print "  ##Xdummy:##\n";
-				print "  Driver \"dummy\"\n";
-			}
-			if (!$got_VideoRam) {
-				print "  ##Xdummy:##\n";
-				print "  VideoRam $videoram\n";
-			}
-		} elsif ($sect eq "screen") {
-			if ($depth ne "" && !got_DefaultDepth) {
-				print "  ##Xdummy:##\n";
-				print "  DefaultDepth $depth\n";
-			}
-			if ($got_Monitor eq "") {
-				print "  ##Xdummy:##\n";
-				print "  Monitor \"Monitor0\"\n";
-			}
-		} elsif ($sect eq "monitor") {
-			if (!got_HorizSync) {
-				print "  ##Xdummy:##\n";
-				print "  HorizSync   $HorizSync\n";
-			}
-			if (!got_VertRefresh) {
-				print "  ##Xdummy:##\n";
-				print "  VertRefresh $VertRefresh\n";
-			}
-			if (!$nomodelines) {
-				print "  ##Xdummy:##\n";
-				print $mode_str;
-			}
-		}
-		$sect = "";
-		print;
-		next;
-	}
-
-	if (/^\s*SubSection\s+(\S+)/i) {
-		# start of Section
-		$subsect = $1;
-		$subsect =~ s/\W//g;
-		$subsect =~ y/A-Z/a-z/;
-		$subsects{$subsect} = 1;
-		if ($sect eq "screen" && $subsect eq "display") {
-			$got_Modes = 0;
-		}
-		print;
-		next;
-	}
-	if (/^\s*EndSubSection/i) {
-		# end of SubSection
-		if ($sect eq "screen") {
-			if ($subsect eq "display") {
-				if ($depth ne "" && !$set_Depth) {
-					print "          ##Xdummy:##\n";
-					print "          Depth\t$depth\n";
-				}
-				if ($geom ne "" && ! $got_Modes) {
-					print "          ##Xdummy:##\n";
-					print "          Modes\t$geom\n";
-				}
-			}
-		}
-		$subsect = "";
-		print;
-		next;
-	}
-
-	$l = $_;
-	$l =~ s/#.*$//;
-	if ($sect eq "serverflags") {
-		if ($l =~ /^\s*Option.*DontVTSwitch/i) {
-			$_ =~ s/false/true/ig;
-			$got_DontVTSwitch = 1;
-		}
-		if ($l =~ /^\s*Option.*AllowMouseOpenFail/i) {
-			$_ =~ s/false/true/ig;
-			$got_AllowMouseOpenFail = 1;
-		}
-		if ($l =~ /^\s*Option.*PciForceNone/i) {
-			$_ =~ s/false/true/ig;
-			$got_PciForceNone= 1;
-		}
-	}
-	if ($sect eq "module") {
-		if ($l =~ /^\s*Load.*\b(dri|fbdevhw)\b/i) {
-			$_ = "##Xdummy## $_";
-		}
-	}
-	if ($sect eq "monitor") {
-		if ($l =~ /^\s*HorizSync/i) {
-			$got_HorizSync = 1;
-		}
-		if ($l =~ /^\s*VertRefresh/i) {
-			$got_VertRefresh = 1;
-		}
-	}
-	if ($sect eq "device") {
-		if ($l =~ /^(\s*Driver)\b/i) {
-			$_ = "$1 \"dummy\"\n";
-			$got_Driver = 1;
-		}
-		if ($l =~ /^\s*VideoRam/i) {
-			$got_VideoRam= 1;
-		}
-	}
-	if ($sect eq "inputdevice") {
-		if ($l =~ /^\s*Option.*\bDevice\b/i) {
-			print "  ##Xdummy:##\n";
-			$_ = "  Option \"Device\" \"/dev/dilbert$n\"\n";
-		}
-	}
-	if ($sect eq "screen") {
-		if ($l =~ /^\s*DefaultDepth\s+(\d+)/i) {
-			if ($depth ne "") {
-				print "  ##Xdummy:##\n";
-				$_ = "  DefaultDepth\t$depth\n";
-			}
-			$got_DefaultDepth = 1;
-		}
-		if ($l =~ /^\s*Monitor\s+(\S+)/i) {
-			$got_Monitor = $1;
-			$got_Monitor =~ s/"//g;
-		}
-		if ($subsect eq "display") {
-			if ($geom ne "") {
-				if ($l =~ /^(\s*Modes)\b/i) {
-					print "          ##Xdummy:##\n";
-					$_ = "$1 $geom\n";
-					$got_Modes = 1;
-				}
-			}
-			if ($l =~ /^\s*Depth\s+(\d+)/i) {
-				my $d = $1;
-				if (!$set_Depth && $depth ne "") {
-					$set_Depth = 1;
-					if ($depth != $d) {
-						print "          ##Xdummy:##\n";
-						$_ =  "          Depth\t$depth\n";
-					}
-				}
-			}
-		}
-	}
-	print;
-    }
-    if ($ENV{XDUMMY_NOTWEAK}) {
-	exit;
-    }
-    # create any crucial sections that are missing:
-    if (! exists($sects{serverflags})) {
-	print "\n##Xdummy:##\n";
-    	print "Section \"ServerFlags\"\n";
-    	print "  Option \"DontVTSwitch\" \"true\"\n";
-    	print "  Option \"AllowMouseOpenFail\" \"true\"\n";
-    	print "  Option \"PciForceNone\" \"true\"\n";
-    	print "EndSection\n";
-    }
-    if (! exists($sects{device})) {
-	print "\n##Xdummy:##\n";
-    	print "Section \"Device\"\n";
-    	print "  Identifier \"Videocard0\"\n";
-    	print "  Driver \"dummy\"\n";
-	print "  VideoRam $videoram\n";
-    	print "EndSection\n";
-    }
-    if (! exists($sects{monitor})) {
-	print "\n##Xdummy:##\n";
-    	print "Section \"Monitor\"\n";
-    	print "  Identifier \"Monitor0\"\n";
-    	print "  HorizSync   $HorizSync\n";
-    	print "  VertRefresh $VertRefresh\n";
-    	print "EndSection\n";
-    }
-    if (! exists($sects{screen})) {
-	print "\n##Xdummy:##\n";
-    	print "Section \"Screen\"\n";
-    	print "  Identifier \"Screen0\"\n";
-    	print "  Device \"Videocard0\"\n";
-	if ($got_Monitor ne "") {
-    		print "  Monitor \"$got_Monitor\"\n";
-	} else {
-    		print "  Monitor \"Monitor0\"\n";
-	}
-	if ($depth ne "") {
-    		print "  DefaultDepth $depth\n";
-	} else {
-    		print "  DefaultDepth 24\n";
-	}
-    	print "  SubSection \"Display\"\n";
-    	print "    Viewport 0 0\n";
-    	print "    Depth 24\n";
-	if ($got_Modes) {
-		;
-	} elsif ($geom ne "") {
-    		print "    Modes $geom\n";
-	} else {
-    		print "    Modes \"1280x1024\" \"1024x768\" \"800x600\"\n";
-	}
-    	print "  EndSubSection\n";
-    	print "EndSection\n";
-    }
-';
-}
-
-# Work out config file and tweak it.
-#
-if [ "X$cmdline_config" = "X" ]; then
-	:
-elif [ "X$cmdline_config" = "Xxdummy-builtin" ]; then
-	:
-elif echo "$cmdline_config" | grep '/' > /dev/null; then
-	:
-else
-	# ignore basename only case (let server handle it)
-	cmdline_config=""
-	notweak=1
-fi
-
-config=$cmdline_config
-
-if [ "X$notweak" = "X1" -a "X$root" = "X" -a  -f "$cmdline_config" ]; then
-	# if not root we need to copy (but not tweak) the specified config.
-	XDUMMY_NOTWEAK=1
-	export XDUMMY_NOTWEAK
-	notweak=""
-fi
-
-if [ ! $notweak ]; then
-	# tweaked config will be put in $config2:
-	config2=""
-	if [ "X$config" = "X" ]; then
-		# use the default one:
-		if [ "X$stype" = "Xxorg" ]; then
-			config=/etc/X11/xorg.conf
-		else
-			if [ -f "/etc/X11/XF86Config-4" ]; then
-				config="/etc/X11/XF86Config-4"
-			else
-				config="/etc/X11/XF86Config"
-			fi
-		fi
-		if [ ! -f "$config" ]; then
-			for c in /etc/X11/xorg.conf /etc/X11/XF86Config-4 /etc/X11/XF86Config
-			do
-				if [ -f $c ]; then
-					config=$c
-					break
-				fi
-			done
-		fi
-	fi
-
-	if [ "X$config" = "Xxdummy-builtin" ]; then
-		config=""
-	fi
-
-	if [ ! -f "$config" ]; then
-		config="$XDUMMY_TMPDIR/xorg.conf"
-		warn "$program: using minimal built-in xorg.conf settings."
-		cat > $config <<END
-
-Section "ServerLayout"
-    Identifier     "Layout0"
-    Screen      0  "Screen0"
-    InputDevice    "Keyboard0" "CoreKeyboard"
-    InputDevice    "Mouse0" "CorePointer"
-EndSection
-
-Section "Files"
-EndSection
-
-Section "Module"
-    Load           "dbe"
-    Load           "extmod"
-    Load           "freetype"
-    Load           "glx"
-EndSection
-
-Section "InputDevice"
-    Identifier     "Mouse0"
-    Driver         "mouse"
-    Option         "Protocol" "auto"
-    Option         "Device" "/dev/psaux"
-    Option         "Emulate3Buttons" "no"
-    Option         "ZAxisMapping" "4 5"
-EndSection
-
-Section "InputDevice"
-    Identifier     "Keyboard0"
-    Driver         "kbd"
-EndSection
-
-Section "Monitor"
-    Identifier     "Monitor0"
-    VendorName     "Unknown"
-    ModelName      "Unknown"
-    HorizSync       30.0 - 130.0
-    VertRefresh     50.0 - 250.0
-    Option         "DPMS"
-EndSection
-
-Section "Device"
-    Identifier     "Device0"
-    Driver         "foovideo"
-    VendorName     "foovideo Corporation"
-EndSection
-
-Section "Screen"
-    Identifier     "Screen0"
-    Device         "Device0"
-    Monitor        "Monitor0"
-    DefaultDepth    24
-    SubSection     "Display"
-        Depth       24
-        Modes           "1280x1024"
-    EndSubSection
-EndSection
-
-END
-	fi
-
-	if [ -f "$config" ]; then
-		tweak_config $config
-	fi
-
-	# now we need to get our tweaked config file onto the command line:
-	if [ "X$cmdline_config" = "X" ]; then
-		# append to cmdline (FUBAR will be substituted below.)
-		if [ "X$stype" = "Xxorg" ]; then
-			args="$args -config FUBAR"
-		else
-			args="$args -xf86config FUBAR"
-		fi
-	fi
-	if [ "X$config2" != "X" ]; then
-		# or modify $args:
-		c2=$config2
-		if [ "X$root" = "X" ]; then
-			# ordinary user cannot use absolute path.
-			c2=`basename $config2`
-		fi
-		args=`echo "$args" | sed \
-			-e "s,-config  *[^ ][^ ]*,-config $c2,g" \
-			-e "s,-xf86config  *[^ ][^ ]*,-xf86config $c2,g"`
-	fi
-fi
-
-if [ $prconf ]; then
-	warn ""
-	warn "Printing out the Xorg/XFree86 server config file:"
-	warn ""
-	if [ "X$config2" = "X" ]; then
-		warn "NO CONFIG GENERATED."
-		exit 1
-	else
-		cat "$config2"
-	fi
-	exit 0
-fi
-
-if [ $debug ]; then
-	XDUMMY_DEBUG=1
-	export XDUMMY_DEBUG
-fi
-if [ $root ]; then
-	XDUMMY_ROOT=1
-	export XDUMMY_ROOT
-fi
-
-# Finally, run it:
-#
-if [ "X$debug" != "X" -o "X$runit" = "X" ]; then
-	if [ ! $runit ]; then
-		echo ""
-		echo "/usr/bin/env:"
-		env | egrep -v '^(LS_COLORS|TERMCAP)' | sort
-		echo ""
-		echo "XDUMMY*:"
-		env | grep '^XDUMMY' | sort
-		echo ""
-	fi
-	warn ""
-	warn "The command to run is:"
-	warn ""
-	so=$SO
-	pwd=`pwd`
-	if echo "$so" | grep '^\./' > /dev/null; then
-		so=`echo "$so" | sed -e "s,^\.,$pwd,"`
-	fi
-	if echo "$so" | grep '/' > /dev/null; then
-		:
-	else
-		so="$pwd/$so"
-	fi
-	warn "env LD_PRELOAD=$so $xserver $disp $args $vt"
-	warn ""
-	if [ ! $runit ]; then
-		exit 0
-	fi
-fi
-
-if [ $strace ]; then
-	if [ "X$strace" = "X2" ]; then
-		ltrace -f env LD_PRELOAD=$SO $xserver $disp $args $vt
-	else
-		strace -f env LD_PRELOAD=$SO $xserver $disp $args $vt
-	fi
-else
-	exec env LD_PRELOAD=$SO $xserver $disp $args $vt
-fi
-
-exit $?
-
-#########################################################################
-
-code() {
-#code_begin
-#include <stdio.h>
-#define O_ACCMODE          0003
-#define O_RDONLY             00
-#define O_WRONLY             01
-#define O_RDWR               02
-#define O_CREAT            0100 /* not fcntl */
-#define O_EXCL             0200 /* not fcntl */
-#define O_NOCTTY           0400 /* not fcntl */
-#define O_TRUNC           01000 /* not fcntl */
-#define O_APPEND          02000
-#define O_NONBLOCK        04000
-#define O_NDELAY        O_NONBLOCK
-#define O_SYNC           010000
-#define O_FSYNC          O_SYNC
-#define O_ASYNC          020000
-
-#include <unistd.h>
-#include <stdlib.h>
-#include <string.h>
-
-#include <linux/vt.h>
-#include <linux/kd.h>
-
-#define __USE_GNU
-#include <dlfcn.h>
-
-static char tmpdir[4096];
-static char str1[4096];
-static char str2[4096];
-
-static char devs[256][1024];
-static int debug = -1;
-static int root = -1;
-static int changed_uid = 0;
-static int saw_fonts = 0;
-static int saw_lib_modules = 0;
-
-static time_t start = 0; 
-
-void check_debug(void) {
-	if (debug < 0) {
-		if (getenv("XDUMMY_DEBUG") != NULL) {
-			debug = 1;
-		} else {
-			debug = 0;
-		}
-		/* prevent other processes using the preload: */
-		putenv("LD_PRELOAD=");
-	}
-}
-void check_root(void) {
-	if (root < 0) {
-		/* script tells us if we are root */
-		if (getenv("XDUMMY_ROOT") != NULL) {
-			root = 1;
-		} else {
-			root = 0;
-		}
-	}
-}
-
-void check_uid(void) {
-	if (start == 0) {
-		start = time(NULL);
-		if (debug) fprintf(stderr, "START: %u\n", (unsigned int) start);
-		return;
-	} else if (changed_uid == 0) {
-		if (saw_fonts || time(NULL) > start + 20) {
-			if (getenv("XDUMMY_UID")) {
-				int uid = atoi(getenv("XDUMMY_UID"));
-				if (debug) fprintf(stderr, "SETREUID: %d saw_fonts=%d\n", uid, saw_fonts);
-				if (uid >= 0) {
-					/* this will simply fail in -nonroot mode: */
-					setreuid(uid, -1);
-				}
-			}
-			changed_uid = 1;
-		}
-	}
-}
-
-#define CHECKIT if (debug < 0) check_debug(); \
-		if (root  < 0) check_root(); \
-		check_uid();
-
-static void set_tmpdir(void) {
-	char *s;
-	static int didset = 0;
-	if (didset) {
-		return;
-	}
-	s = getenv("XDUMMY_TMPDIR");
-	if (! s) {
-		s = "/tmp";
-	}
-	tmpdir[0] = '\0';
-	strcat(tmpdir, s);
-	strcat(tmpdir, "/");
-	didset = 1;
-}
-
-static char *tmpdir_path(const char *path) {
-	char *str;
-	set_tmpdir();
-	strcpy(str2, path);
-	str = str2;
-	while (*str) {
-		if (*str == '/') {
-			*str = '_';
-		}
-		str++;
-	}
-	strcpy(str1, tmpdir);
-	strcat(str1, str2);
-	return str1;
-}
-
-int open(const char *pathname, int flags, unsigned short mode) {
-	int fd;
-	char *store_dev = NULL;
-	static int (*real_open)(const char *, int , unsigned short) = NULL;
-
-	CHECKIT
-	if (! real_open) {
-		real_open = (int (*)(const char *, int , unsigned short))
-			dlsym(RTLD_NEXT, "open");
-	}
-
-	if (strstr(pathname, "lib/modules/")) {
-		/* not currently used. */
-		saw_lib_modules = 1;
-	}
-
-	if (!root) {
-		if (strstr(pathname, "/dev/") == pathname) {
-			store_dev = strdup(pathname);
-		}
-		if (strstr(pathname, "/dev/tty") == pathname && strcmp(pathname, "/dev/tty")) {
-			pathname = tmpdir_path(pathname);
-			if (debug) fprintf(stderr, "OPEN: %s -> %s (as FIFO)\n", store_dev, pathname);
-			/* we make it a FIFO so ioctl on it does not fail */
-			unlink(pathname);
-			mkfifo(pathname, 0666);
-		} else if (0) {
-			/* we used to handle more /dev files ... */
-			fd = real_open(pathname, O_WRONLY|O_CREAT, 0777);
-			close(fd);
-		}
-	}
-
-	fd = real_open(pathname, flags, mode);
-
-	if (debug) fprintf(stderr, "OPEN: %s %d %d fd=%d\n", pathname, flags, mode, fd);
-
-	if (! root) {
-		if (store_dev) {
-			if (fd < 256) {
-				strcpy(devs[fd], store_dev);
-			}
-			free(store_dev);
-		}
-	}
-
-	return(fd);
-}
-
-int open64(const char *pathname, int flags, unsigned short mode) {
-	int fd;
-
-	CHECKIT
-	if (debug) fprintf(stderr, "OPEN64: %s %d %d\n", pathname, flags, mode);
-
-	fd = open(pathname, flags, mode);
-	return(fd);
-}
-
-int rename(const char *oldpath, const char *newpath) {
-	static int (*real_rename)(const char *, const char *) = NULL;
-
-	CHECKIT
-	if (! real_rename) {
-		real_rename = (int (*)(const char *, const char *))
-			dlsym(RTLD_NEXT, "rename");
-	}
-
-	if (debug) fprintf(stderr, "RENAME: %s %s\n", oldpath, newpath);
-
-	if (root) {
-		return(real_rename(oldpath, newpath));
-	}
-
-	if (strstr(oldpath, "/var/log") == oldpath) {
-		if (debug) fprintf(stderr, "RENAME: returning 0\n");
-		return 0;
-	}
-	return(real_rename(oldpath, newpath));
-}
-
-FILE *fopen(const char *pathname, const char *mode) {
-	static FILE* (*real_fopen)(const char *, const char *) = NULL;
-	char *str;
-
-	if (! saw_fonts) {
-		if (strstr(pathname, "/fonts/")) {
-			if (strstr(pathname, "fonts.dir")) {
-				saw_fonts = 1;
-			} else if (strstr(pathname, "fonts.alias")) {
-				saw_fonts = 1;
-			}
-		}
-	}
-
-	CHECKIT
-	if (! real_fopen) {
-		real_fopen = (FILE* (*)(const char *, const char *))
-			dlsym(RTLD_NEXT, "fopen");
-	}
-
-	if (debug) fprintf(stderr, "FOPEN: %s %s\n", pathname, mode);
-
-	if (strstr(pathname, "xdummy_modified_xconfig.conf")) {
-		/* make our config appear to be in /etc/X11, etc. */
-		char *q = strrchr(pathname, '/');
-		if (q != NULL && getenv("XDUMMY_TMPDIR") != NULL) {
-			strcpy(str1, getenv("XDUMMY_TMPDIR"));
-			strcat(str1, q);
-			if (debug) fprintf(stderr, "FOPEN: %s -> %s\n", pathname, str1);
-			pathname = str1;
-		}
-	}
-
-	if (root) {
-		return(real_fopen(pathname, mode));
-	}
-
-	str = (char *) pathname;
-	if (strstr(pathname, "/var/log") == pathname) {
-		str = tmpdir_path(pathname);
-		if (debug) fprintf(stderr, "FOPEN: %s -> %s\n", pathname, str);
-	}
-	return(real_fopen(str, mode));
-}
-
-
-#define RETURN0 if (debug) \
-	{fprintf(stderr, "IOCTL: covered %d 0x%x\n", fd, req);} return 0;
-#define RETURN1 if (debug) \
-	{fprintf(stderr, "IOCTL: covered %d 0x%x\n", fd, req);} return -1;
-
-int ioctl(int fd, int req, void *ptr) {
-	static int closed_xf86Info_consoleFd = 0;
-	static int (*real_ioctl)(int, int , void *) = NULL;
-
-	CHECKIT
-	if (! real_ioctl) {
-		real_ioctl = (int (*)(int, int , void *))
-			dlsym(RTLD_NEXT, "open");
-	}
-	if (debug) fprintf(stderr, "IOCTL: %d 0x%x %p\n", fd, req, ptr);
-
-	/* based on xorg-x11-6.8.1-dualhead.patch */
-	if (req == VT_GETMODE) {
-		/* close(xf86Info.consoleFd) */
-		if (0 && ! closed_xf86Info_consoleFd) {
-			/* I think better not to close it... */
-			close(fd);
-			closed_xf86Info_consoleFd = 1;
-		}
-		RETURN0
-	} else if (req == VT_SETMODE) {
-		RETURN0
-	} else if (req == VT_GETSTATE) {
-		RETURN0
-	} else if (req == KDSETMODE) {
-		RETURN0
-	} else if (req == KDSETLED) {
-		RETURN0
-	} else if (req == KDGKBMODE) {
-		RETURN0
-	} else if (req == KDSKBMODE) {
-		RETURN0
-	} else if (req == VT_ACTIVATE) {
-		RETURN0
-	} else if (req == VT_WAITACTIVE) {
-		RETURN0
-	} else if (req == VT_RELDISP) {
-		if (ptr == (void *) 1) {
-			RETURN1
-		} else if (ptr == (void *) VT_ACKACQ) {
-			RETURN0
-		}
-	}
-
-	return(real_ioctl(fd, req, ptr));
-}
-
-typedef void (*sighandler_t)(int);
-#define SIGUSR1       10
-#define SIG_DFL       ((sighandler_t)0)
-
-sighandler_t signal(int signum, sighandler_t handler) {
-	static sighandler_t (*real_signal)(int, sighandler_t) = NULL;
-
-	CHECKIT
-	if (! real_signal) {
-		real_signal = (sighandler_t (*)(int, sighandler_t))
-			dlsym(RTLD_NEXT, "signal");
-	}
-
-	if (debug) fprintf(stderr, "SIGNAL: %d %p\n", signum, handler);
-
-	if (signum == SIGUSR1) {
-		if (debug) fprintf(stderr, "SIGNAL: skip SIGUSR1\n");
-		return SIG_DFL;
-	}
-	
-	return(real_signal(signum, handler));
-}
-
-int close(int fd) {
-	static int (*real_close)(int) = NULL;
-
-	CHECKIT
-	if (! real_close) {
-		real_close = (int (*)(int)) dlsym(RTLD_NEXT, "close");
-	}
-
-	if (debug) fprintf(stderr, "CLOSE: %d\n", fd);
-	if (!root) {
-		if (fd < 256) {
-			devs[fd][0] = '\0';
-		}
-	}
-	return(real_close(fd));
-}
-
-struct stat {
-	int foo;
-};
-
-int stat(const char *path, struct stat *buf) {
-	static int (*real_stat)(const char *, struct stat *) = NULL;
-
-	CHECKIT
-	if (! real_stat) {
-		real_stat = (int (*)(const char *, struct stat *))
-			dlsym(RTLD_NEXT, "stat");
-	}
-
-	if (debug) fprintf(stderr, "STAT: %s\n", path);
-
-	return(real_stat(path, buf));
-}
-
-int stat64(const char *path, struct stat *buf) {
-	static int (*real_stat64)(const char *, struct stat *) = NULL;
-
-	CHECKIT
-	if (! real_stat64) {
-		real_stat64 = (int (*)(const char *, struct stat *))
-			dlsym(RTLD_NEXT, "stat64");
-	}
-
-	if (debug) fprintf(stderr, "STAT64: %s\n", path);
-
-	return(real_stat64(path, buf));
-}
-
-int chown(const char *path, uid_t owner, gid_t group) {
-	static int (*real_chown)(const char *, uid_t, gid_t) = NULL;
-
-	CHECKIT
-	if (! real_chown) {
-		real_chown = (int (*)(const char *, uid_t, gid_t))
-			dlsym(RTLD_NEXT, "chown");
-	}
-
-	if (root) {
-		return(real_chown(path, owner, group));
-	}
-
-	if (debug) fprintf(stderr, "CHOWN: %s %d %d\n", path, owner, group);
-
-	if (strstr(path, "/dev") == path) {
-		if (debug) fprintf(stderr, "CHOWN: return 0\n");
-		return 0;
-	}
-
-	return(real_chown(path, owner, group));
-}
-
-extern int *__errno_location (void);
-#ifndef ENODEV
-#define ENODEV 19
-#endif
-
-int ioperm(unsigned long from, unsigned long num, int turn_on) {
-	static int (*real_ioperm)(unsigned long, unsigned long, int) = NULL;
-
-	CHECKIT
-	if (! real_ioperm) {
-		real_ioperm = (int (*)(unsigned long, unsigned long, int))
-			dlsym(RTLD_NEXT, "ioperm");
-	}
-	if (debug) fprintf(stderr, "IOPERM: %d %d %d\n", (int) from, (int) num, turn_on);
-	if (root) {
-		return(real_ioperm(from, num, turn_on));
-	}
-	if (from == 0 && num == 1024 && turn_on == 1) {
-		/* we want xf86EnableIO to fail */
-		if (debug) fprintf(stderr, "IOPERM: setting ENODEV.\n");
-		*__errno_location() = ENODEV;
-		return -1;
-	}
-	return 0;
-}
-
-int iopl(int level) {
-	static int (*real_iopl)(int) = NULL;
-
-	CHECKIT
-	if (! real_iopl) {
-		real_iopl = (int (*)(int)) dlsym(RTLD_NEXT, "iopl");
-	}
-	if (debug) fprintf(stderr, "IOPL: %d\n", level);
-	if (root) {
-		return(real_iopl(level));
-	}
-	return 0;
-}
-
-#ifdef INTERPOSE_GETUID 
-
-/*
- * we got things to work w/o pretending to be root.
- * so we no longer interpose getuid(), etc.
- */
-
-uid_t getuid(void) {
-	static uid_t (*real_getuid)(void) = NULL;
-	CHECKIT
-	if (! real_getuid) {
-		real_getuid = (uid_t (*)(void)) dlsym(RTLD_NEXT, "getuid");
-	}
-	if (root) {
-		return(real_getuid());
-	}
-	if (debug) fprintf(stderr, "GETUID: 0\n");
-	return 0;
-}
-uid_t geteuid(void) {
-	static uid_t (*real_geteuid)(void) = NULL;
-	CHECKIT
-	if (! real_geteuid) {
-		real_geteuid = (uid_t (*)(void)) dlsym(RTLD_NEXT, "geteuid");
-	}
-	if (root) {
-		return(real_geteuid());
-	}
-	if (debug) fprintf(stderr, "GETEUID: 0\n");
-	return 0;
-}
-uid_t geteuid_kludge1(void) {
-	static uid_t (*real_geteuid)(void) = NULL;
-	CHECKIT
-	if (! real_geteuid) {
-		real_geteuid = (uid_t (*)(void)) dlsym(RTLD_NEXT, "geteuid");
-	}
-	if (debug) fprintf(stderr, "GETEUID: 0 saw_libmodules=%d\n", saw_lib_modules);
-	if (root && !saw_lib_modules) {
-		return(real_geteuid());
-	} else {
-		saw_lib_modules = 0;
-		return 0;
-	}
-}
-
-uid_t getuid32(void) {
-	static uid_t (*real_getuid32)(void) = NULL;
-	CHECKIT
-	if (! real_getuid32) {
-		real_getuid32 = (uid_t (*)(void)) dlsym(RTLD_NEXT, "getuid32");
-	}
-	if (root) {
-		return(real_getuid32());
-	}
-	if (debug) fprintf(stderr, "GETUID32: 0\n");
-	return 0;
-}
-uid_t geteuid32(void) {
-	static uid_t (*real_geteuid32)(void) = NULL;
-	CHECKIT
-	if (! real_geteuid32) {
-		real_geteuid32 = (uid_t (*)(void)) dlsym(RTLD_NEXT, "geteuid32");
-	}
-	if (root) {
-		return(real_geteuid32());
-	}
-	if (debug) fprintf(stderr, "GETEUID32: 0\n");
-	return 0;
-}
-
-gid_t getgid(void) {
-	static gid_t (*real_getgid)(void) = NULL;
-	CHECKIT
-	if (! real_getgid) {
-		real_getgid = (gid_t (*)(void)) dlsym(RTLD_NEXT, "getgid");
-	}
-	if (root) {
-		return(real_getgid());
-	}
-	if (debug) fprintf(stderr, "GETGID: 0\n");
-	return 0;
-}
-gid_t getegid(void) {
-	static gid_t (*real_getegid)(void) = NULL;
-	CHECKIT
-	if (! real_getegid) {
-		real_getegid = (gid_t (*)(void)) dlsym(RTLD_NEXT, "getegid");
-	}
-	if (root) {
-		return(real_getegid());
-	}
-	if (debug) fprintf(stderr, "GETEGID: 0\n");
-	return 0;
-}
-gid_t getgid32(void) {
-	static gid_t (*real_getgid32)(void) = NULL;
-	CHECKIT
-	if (! real_getgid32) {
-		real_getgid32 = (gid_t (*)(void)) dlsym(RTLD_NEXT, "getgid32");
-	}
-	if (root) {
-		return(real_getgid32());
-	}
-	if (debug) fprintf(stderr, "GETGID32: 0\n");
-	return 0;
-}
-gid_t getegid32(void) {
-	static gid_t (*real_getegid32)(void) = NULL;
-	CHECKIT
-	if (! real_getegid32) {
-		real_getegid32 = (gid_t (*)(void)) dlsym(RTLD_NEXT, "getegid32");
-	}
-	if (root) {
-		return(real_getegid32());
-	}
-	if (debug) fprintf(stderr, "GETEGID32: 0\n");
-	return 0;
-}
-#endif
-
-#if 0
-/* maybe we need to interpose on strcmp someday... here is the template */
-int strcmp(const char *s1, const char *s2) {
-	static int (*real_strcmp)(const char *, const char *) = NULL;
-	CHECKIT
-	if (! real_strcmp) {
-		real_strcmp = (int (*)(const char *, const char *)) dlsym(RTLD_NEXT, "strcmp");
-	}
-	if (debug) fprintf(stderr, "STRCMP: '%s' '%s'\n", s1, s2);
-	return(real_strcmp(s1, s2));
-}
-#endif
-
-#code_end
-}
diff --git a/azure/files/mjkey.txt b/azure/files/mjkey.txt
deleted file mode 100644
index c26fd78..0000000
--- a/azure/files/mjkey.txt
+++ /dev/null
@@ -1,17 +0,0 @@
-MuJoCo Pro Individual license activation key, number 7777, type 6.
-
-Issued to Everyone.
-
-Expires October 18, 2031.
-
-Do not modify this file. Its entire content, including the
-plain text section, is used by the activation manager.
-
-9aaedeefb37011a8a52361c736643665c7f60e796ff8ff70bb3f7a1d78e9a605
-0453a3c853e4aa416e712d7e80cf799c6314ee5480ec6bd0f1ab51d1bb3c768f
-8c06e7e572f411ecb25c3d6ef82cc20b00f672db88e6001b3dfdd3ab79e6c480
-185d681811cfdaff640fb63295e391b05374edba90dd54cc1e162a9d99b82a8b
-ea3e87f2c67d08006c53daac2e563269cdb286838b168a2071c48c29fedfbea2
-5effe96fe3cb05e85fb8af2d3851f385618ef8cdac42876831f095e052bd18c9
-5dce57ff9c83670aad77e5a1f41444bec45e30e4e827f7bf9799b29f2c934e23
-dcf6d3c3ee9c8dd2ed057317100cd21b4abbbf652d02bf72c3d322e0c55dcc24
\ No newline at end of file
diff --git a/azure/launch.py b/azure/launch.py
deleted file mode 100644
index 7df0ed2..0000000
--- a/azure/launch.py
+++ /dev/null
@@ -1,64 +0,0 @@
-import os
-import pdb
-
-from doodad.wrappers.easy_launch import sweep_function, save_doodad_config
-
-codepath = '/home/code'
-script = 'scripts/train.py'
-
-
-def remote_fn(doodad_config, variant):
-    kwarg_string = ' '.join([
-        f'--{k} {v}' for k, v in variant.items()
-    ])
-    print(kwarg_string)
-
-    config = 'config.locomotion'
-
-    d4rl_path = os.path.join(doodad_config.output_directory, 'datasets/')
-    os.system(f'ls -a {codepath}')
-    os.system(f'mv {codepath}/git {codepath}/.git')
-    os.system(
-        f'''export PYTHONPATH=$PYTHONPATH:{codepath} && '''
-        f'''export CUDA_VISIBLE_DEVICES=0 && '''
-        f'''export D4RL_DATASET_DIR={d4rl_path} && '''
-        f'''python {os.path.join(codepath, script)} '''
-        f'''--config {config} '''
-        f'''{kwarg_string}'''
-    )
-    save_doodad_config(doodad_config)
-
-
-if __name__ == "__main__":
-
-    environments = ['walker2d']
-    buffers = ['medium-expert-v2']
-    datasets = [f'{env}-{buf}' for env in environments for buf in buffers]
-
-    azure_logpath = 'pretrained'
-
-    params_to_sweep = {
-        'dataset': datasets,
-        'horizon': [128, 512],
-        'n_diffusion_steps': [100],
-        'bucket': [None],
-    }
-
-    default_params = {
-        'logbase': os.path.join('/doodad_tmp', 'logs', azure_logpath),
-        'prefix': 'diffusion/',
-    }
-
-    sweep_function(
-        remote_fn,
-        params_to_sweep,
-        default_params=default_params,
-        config_path=os.path.abspath('azure/config.py'),
-        gpu_model='nvidia-tesla-v100',
-        azure_region='eastus2',
-        storage_container='diffuser-pretrained',
-        log_path=azure_logpath,
-        filter_ext=['.pyc', '.egg-info', '.png', '.ai'],
-        filter_dir=['logs', 'bin'],
-        use_gpu=True,
-    )
diff --git a/azure/sync.sh b/azure/sync.sh
deleted file mode 100644
index 0362d6f..0000000
--- a/azure/sync.sh
+++ /dev/null
@@ -1,22 +0,0 @@
-if keyctl show 2>&1 | grep -q "workaroundSession";
-then
-	echo "Already logged in"
-else
-	echo "Logging in with tenant id:" ${AZURE_TENANT_ID}
-	keyctl session workaroundSession
-	./bin/azcopy login --tenant-id=$AZURE_TENANT_ID
-fi
-
-export LOCAL_LOGBASE=logs/pretrained/
-export LOGBASE=logs/pretrained/
-export AZURE_STORAGE_CONTAINER="diffuser-pretrained"
-
-## AZURE_STORAGE_CONNECTION_STRING has a substring formatted lik:
-	## AccountName=${STORAGE_ACCOUNT};AccountKey= ...
-export AZURE_STORAGE_ACCOUNT=`(echo $AZURE_STORAGE_CONNECTION_STRING | grep -o -P '(?<=AccountName=).*(?=;AccountKey)')`
-
-echo "Syncing from" ${AZURE_STORAGE_ACCOUNT}"/"${AZURE_STORAGE_CONTAINER}"/"${LOGBASE}
-
-mkdir -p ${LOCAL_LOGBASE}
-
-./bin/azcopy sync https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_STORAGE_CONTAINER}/${LOGBASE} ${LOCAL_LOGBASE} --recursive
diff --git a/config/locomotion.py b/config/locomotion.py
deleted file mode 100644
index 4410bb1..0000000
--- a/config/locomotion.py
+++ /dev/null
@@ -1,70 +0,0 @@
-import socket
-
-from diffuser.utils import watch
-
-#------------------------ base ------------------------#
-
-## automatically make experiment names for planning
-## by labelling folders with these args
-
-diffusion_args_to_watch = [
-    ('prefix', ''),
-    ('horizon', 'H'),
-    ('n_diffusion_steps', 'T'),
-]
-
-base = {
-    'diffusion': {
-        ## model
-        'model': 'models.TemporalUnet',
-        'diffusion': 'models.GaussianDiffusion',
-        'horizon': 32,
-        'n_diffusion_steps': 100,
-        'action_weight': 10,
-        'loss_weights': None,
-        'loss_discount': 1,
-        'predict_epsilon': False,
-        'dim_mults': (1, 4, 8),
-        'renderer': 'utils.MuJoCoRenderer',
-
-        ## dataset
-        'loader': 'datasets.SequenceDataset',
-        'normalizer': 'LimitsNormalizer',
-        'preprocess_fns': [],
-        'clip_denoised': True,
-        'use_padding': True,
-        'max_path_length': 1000,
-
-        ## serialization
-        'logbase': 'logs',
-        'prefix': 'diffusion/',
-        'exp_name': watch(diffusion_args_to_watch),
-
-        ## training
-        'n_steps_per_epoch': 10000,
-        'loss_type': 'l2',
-        'n_train_steps': 1e6,
-        'batch_size': 32,
-        'learning_rate': 2e-4,
-        'gradient_accumulate_every': 2,
-        'ema_decay': 0.995,
-        'save_freq': 1000,
-        'sample_freq': 1000,
-        'n_saves': 5,
-        'save_parallel': False,
-        'n_reference': 8,
-        'n_samples': 2,
-        'bucket': None,
-        'device': 'cuda',
-    },
-}
-
-#------------------------ overrides ------------------------#
-
-## put environment-specific overrides here
-
-halfcheetah_medium_expert_v2 = {
-    'diffusion': {
-        'horizon': 16,
-    },
-}
diff --git a/diffuser/__init__.py b/diffuser/__init__.py
index db6735a..973bec0 100644
--- a/diffuser/__init__.py
+++ b/diffuser/__init__.py
@@ -1 +1 @@
-from . import environments
\ No newline at end of file
+# from . import environments
\ No newline at end of file
diff --git a/diffuser/environments/__init__.py b/diffuser/environments/__init__.py
deleted file mode 100644
index 455bcf3..0000000
--- a/diffuser/environments/__init__.py
+++ /dev/null
@@ -1,3 +0,0 @@
-from .registration import register_environments
-
-registered_environments = register_environments()
\ No newline at end of file
diff --git a/diffuser/environments/ant.py b/diffuser/environments/ant.py
deleted file mode 100644
index e35f6dc..0000000
--- a/diffuser/environments/ant.py
+++ /dev/null
@@ -1,74 +0,0 @@
-import os
-import numpy as np
-from gym import utils
-from gym.envs.mujoco import mujoco_env
-
-'''
-    qpos : 15
-    qvel : 14
-    0-2: root x, y, z
-    3-7: root quat
-    7  : front L hip
-    8  : front L ankle
-    9  : front R hip
-    10 : front R ankle
-    11 : back  L hip
-    12 : back  L ankle
-    13 : back  R hip
-    14 : back  R ankle
-
-'''
-
-class AntFullObsEnv(mujoco_env.MujocoEnv, utils.EzPickle):
-    def __init__(self):
-        asset_path = os.path.join(
-            os.path.dirname(__file__), 'assets/ant.xml')
-        mujoco_env.MujocoEnv.__init__(self, asset_path, 5)
-        utils.EzPickle.__init__(self)
-
-    def step(self, a):
-        xposbefore = self.get_body_com("torso")[0]
-        self.do_simulation(a, self.frame_skip)
-        xposafter = self.get_body_com("torso")[0]
-        forward_reward = (xposafter - xposbefore) / self.dt
-        ctrl_cost = 0.5 * np.square(a).sum()
-        contact_cost = (
-            0.5 * 1e-3 * np.sum(np.square(np.clip(self.sim.data.cfrc_ext, -1, 1)))
-        )
-        survive_reward = 1.0
-        reward = forward_reward - ctrl_cost - contact_cost + survive_reward
-        state = self.state_vector()
-        notdone = np.isfinite(state).all() and state[2] >= 0.2 and state[2] <= 1.0
-        done = not notdone
-        ob = self._get_obs()
-        return (
-            ob,
-            reward,
-            done,
-            dict(
-                reward_forward=forward_reward,
-                reward_ctrl=-ctrl_cost,
-                reward_contact=-contact_cost,
-                reward_survive=survive_reward,
-            ),
-        )
-
-    def _get_obs(self):
-        return np.concatenate(
-            [
-                self.sim.data.qpos.flat[2:],
-                self.sim.data.qvel.flat,
-                np.clip(self.sim.data.cfrc_ext, -1, 1).flat,
-            ]
-        )
-
-    def reset_model(self):
-        qpos = self.init_qpos + self.np_random.uniform(
-            size=self.model.nq, low=-0.1, high=0.1
-        )
-        qvel = self.init_qvel + self.np_random.standard_normal(self.model.nv) * 0.1
-        self.set_state(qpos, qvel)
-        return self._get_obs()
-
-    def viewer_setup(self):
-        self.viewer.cam.distance = self.model.stat.extent * 0.5
\ No newline at end of file
diff --git a/diffuser/environments/assets/ant.xml b/diffuser/environments/assets/ant.xml
deleted file mode 100644
index b8b03cd..0000000
--- a/diffuser/environments/assets/ant.xml
+++ /dev/null
@@ -1,81 +0,0 @@
-<mujoco model="ant">
-  <compiler angle="degree" coordinate="local" inertiafromgeom="true"/>
-  <option integrator="RK4" timestep="0.01"/>
-  <custom>
-    <numeric data="0.0 0.0 0.55 1.0 0.0 0.0 0.0 0.0 1.0 0.0 -1.0 0.0 -1.0 0.0 1.0" name="init_qpos"/>
-  </custom>
-  <default>
-    <joint armature="1" damping="1" limited="true"/>
-    <geom conaffinity="0" condim="3" density="5.0" friction="1 0.5 0.5" margin="0.01" rgba="0.8 0.6 0.4 1"/>
-  </default>
-  <asset>
-    <texture builtin="gradient" height="100" rgb1="1 1 1" rgb2="1 1 1" type="skybox" width="100"/>
-    <texture builtin="flat" height="1278" mark="cross" markrgb="1 1 1" name="texgeom" random="0.01" rgb1="0.8 0.6 0.4" rgb2="0.8 0.6 0.4" type="cube" width="127"/>
-    <!-- <texture builtin="checker" height="100" name="texplane" rgb1="0 0 0" rgb2="0.8 0.8 0.8" type="2d" width="100"/> -->
-    <!-- <material name="MatPlane" reflectance="0.5" shininess="1" specular="1" texrepeat="60 60" texture="texplane"/> -->
-    <material name="geom" texture="texgeom" texuniform="true"/>
-  </asset>
-  <worldbody>
-    <light cutoff="100" diffuse="1 1 1" dir="-0 0 -1.3" directional="true" exponent="1" pos="0 0 1.3" specular=".1 .1 .1"/>
-    <geom conaffinity="1" condim="3" name="floor" pos="0 0 0" rgba="1 1 1 0" size="40 40 40" type="plane"/>
-    <body name="torso" pos="0 0 0.75">
-      <camera name="track" mode="trackcom" pos="0 -3 0.3" xyaxes="1 0 0 0 0 1"/>
-      <geom name="torso_geom" pos="0 0 0" size="0.25" type="sphere"/>
-      <joint armature="0" damping="0" limited="false" margin="0.01" name="root" pos="0 0 0" type="free"/>
-      <body name="front_left_leg" pos="0 0 0">
-        <geom fromto="0.0 0.0 0.0 0.2 0.2 0.0" name="aux_1_geom" size="0.08" type="capsule"/>
-        <body name="aux_1" pos="0.2 0.2 0">
-          <joint axis="0 0 1" name="hip_1" pos="0.0 0.0 0.0" range="-30 30" type="hinge"/>
-          <geom fromto="0.0 0.0 0.0 0.2 0.2 0.0" name="left_leg_geom" size="0.08" type="capsule"/>
-          <body pos="0.2 0.2 0">
-            <joint axis="-1 1 0" name="ankle_1" pos="0.0 0.0 0.0" range="30 70" type="hinge"/>
-            <geom fromto="0.0 0.0 0.0 0.4 0.4 0.0" name="left_ankle_geom" size="0.08" type="capsule"/>
-          </body>
-        </body>
-      </body>
-      <body name="front_right_leg" pos="0 0 0">
-        <geom fromto="0.0 0.0 0.0 -0.2 0.2 0.0" name="aux_2_geom" size="0.08" type="capsule"/>
-        <body name="aux_2" pos="-0.2 0.2 0">
-          <joint axis="0 0 1" name="hip_2" pos="0.0 0.0 0.0" range="-30 30" type="hinge"/>
-          <geom fromto="0.0 0.0 0.0 -0.2 0.2 0.0" name="right_leg_geom" size="0.08" type="capsule"/>
-          <body pos="-0.2 0.2 0">
-            <joint axis="1 1 0" name="ankle_2" pos="0.0 0.0 0.0" range="-70 -30" type="hinge"/>
-            <geom fromto="0.0 0.0 0.0 -0.4 0.4 0.0" name="right_ankle_geom" size="0.08" type="capsule"/>
-          </body>
-        </body>
-      </body>
-      <body name="back_leg" pos="0 0 0">
-        <geom fromto="0.0 0.0 0.0 -0.2 -0.2 0.0" name="aux_3_geom" size="0.08" type="capsule"/>
-        <body name="aux_3" pos="-0.2 -0.2 0">
-          <joint axis="0 0 1" name="hip_3" pos="0.0 0.0 0.0" range="-30 30" type="hinge"/>
-          <geom fromto="0.0 0.0 0.0 -0.2 -0.2 0.0" name="back_leg_geom" size="0.08" type="capsule"/>
-          <body pos="-0.2 -0.2 0">
-            <joint axis="-1 1 0" name="ankle_3" pos="0.0 0.0 0.0" range="-70 -30" type="hinge"/>
-            <geom fromto="0.0 0.0 0.0 -0.4 -0.4 0.0" name="third_ankle_geom" size="0.08" type="capsule"/>
-          </body>
-        </body>
-      </body>
-      <body name="right_back_leg" pos="0 0 0">
-        <geom fromto="0.0 0.0 0.0 0.2 -0.2 0.0" name="aux_4_geom" size="0.08" type="capsule"/>
-        <body name="aux_4" pos="0.2 -0.2 0">
-          <joint axis="0 0 1" name="hip_4" pos="0.0 0.0 0.0" range="-30 30" type="hinge"/>
-          <geom fromto="0.0 0.0 0.0 0.2 -0.2 0.0" name="rightback_leg_geom" size="0.08" type="capsule"/>
-          <body pos="0.2 -0.2 0">
-            <joint axis="1 1 0" name="ankle_4" pos="0.0 0.0 0.0" range="30 70" type="hinge"/>
-            <geom fromto="0.0 0.0 0.0 0.4 -0.4 0.0" name="fourth_ankle_geom" size="0.08" type="capsule"/>
-          </body>
-        </body>
-      </body>
-    </body>
-  </worldbody>
-  <actuator>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" joint="hip_4" gear="150"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" joint="ankle_4" gear="150"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" joint="hip_1" gear="150"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" joint="ankle_1" gear="150"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" joint="hip_2" gear="150"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" joint="ankle_2" gear="150"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" joint="hip_3" gear="150"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" joint="ankle_3" gear="150"/>
-  </actuator>
-</mujoco>
\ No newline at end of file
diff --git a/diffuser/environments/assets/half_cheetah.xml b/diffuser/environments/assets/half_cheetah.xml
deleted file mode 100644
index 9442205..0000000
--- a/diffuser/environments/assets/half_cheetah.xml
+++ /dev/null
@@ -1,94 +0,0 @@
-<!-- Cheetah Model
-    The state space is populated with joints in the order that they are
-    defined in this file. The actuators also operate on joints.
-    State-Space (name/joint/parameter):
-        - rootx     slider      position (m)
-        - rootz     slider      position (m)
-        - rooty     hinge       angle (rad)
-        - bthigh    hinge       angle (rad)
-        - bshin     hinge       angle (rad)
-        - bfoot     hinge       angle (rad)
-        - fthigh    hinge       angle (rad)
-        - fshin     hinge       angle (rad)
-        - ffoot     hinge       angle (rad)
-        - rootx     slider      velocity (m/s)
-        - rootz     slider      velocity (m/s)
-        - rooty     hinge       angular velocity (rad/s)
-        - bthigh    hinge       angular velocity (rad/s)
-        - bshin     hinge       angular velocity (rad/s)
-        - bfoot     hinge       angular velocity (rad/s)
-        - fthigh    hinge       angular velocity (rad/s)
-        - fshin     hinge       angular velocity (rad/s)
-        - ffoot     hinge       angular velocity (rad/s)
-    Actuators (name/actuator/parameter):
-        - bthigh    hinge       torque (N m)
-        - bshin     hinge       torque (N m)
-        - bfoot     hinge       torque (N m)
-        - fthigh    hinge       torque (N m)
-        - fshin     hinge       torque (N m)
-        - ffoot     hinge       torque (N m)
--->
-<mujoco model="cheetah">
-  <compiler angle="radian" coordinate="local" inertiafromgeom="true" settotalmass="14"/>
-  <default>
-    <joint armature=".1" damping=".01" limited="true" solimplimit="0 .8 .03" solreflimit=".02 1" stiffness="8"/>
-    <geom conaffinity="0" condim="3" contype="1" friction=".4 .1 .1" rgba="0.8 0.6 .4 1" solimp="0.0 0.8 0.01" solref="0.02 1"/>
-    <motor ctrllimited="true" ctrlrange="-1 1"/>
-  </default>
-  <size nstack="300000" nuser_geom="1"/>
-  <option gravity="0 0 -9.81" timestep="0.01"/>
-  <asset>
-    <!-- <texture builtin="gradient" height="100" rgb1="1 1 1" rgb2="0 0 0" type="skybox" width="100"/> -->
-    <texture builtin="gradient" height="100" rgb1="1 1 1" rgb2="1 1 1" type="skybox" width="100"/>
-    <texture builtin="flat" height="1278" mark="cross" markrgb="1 1 1" name="texgeom" random="0.01" rgb1="0.8 0.6 0.4" rgb2="0.8 0.6 0.4" type="cube" width="127"/>
-    <!-- <texture builtin="checker" height="100" name="texplane" rgb1="0 0 0" rgb2="0.8 0.8 0.8" type="2d" width="100"/> -->
-    <!-- <material name="MatPlane" reflectance="0.5" shininess="1" specular="1" texrepeat="60 60" texture="texplane"/> -->
-    <material name="geom" texture="texgeom" texuniform="true"/>
-  </asset>
-  <worldbody>
-    <light cutoff="100" diffuse="1 1 1" dir="-0 0 -1.3" directional="true" exponent="1" pos="0 0 1.3" specular=".1 .1 .1"/>
-    <!-- <geom conaffinity="1" condim="3" material="MatPlane" name="floor" pos="0 0 0" rgba="0.8 0.9 0.8 1" size="40 40 40" type="plane"/> -->
-    <geom conaffinity="1" condim="3" name="floor" pos="0 0 0" rgba="1 1 1 0" size="40 40 40" type="plane"/>
-    <body name="torso" pos="0 0 .7">
-      <camera name="track" mode="trackcom" pos="0 -3 0.3" xyaxes="1 0 0 0 0 1"/>
-      <joint armature="0" axis="1 0 0" damping="0" limited="false" name="rootx" pos="0 0 0" stiffness="0" type="slide"/>
-      <joint armature="0" axis="0 0 1" damping="0" limited="false" name="rootz" pos="0 0 0" stiffness="0" type="slide"/>
-      <joint armature="0" axis="0 1 0" damping="0" limited="false" name="rooty" pos="0 0 0" stiffness="0" type="hinge"/>
-      <geom fromto="-.5 0 0 .5 0 0" name="torso" size="0.046" type="capsule"/>
-      <geom axisangle="0 1 0 .87" name="head" pos=".6 0 .1" size="0.046 .15" type="capsule"/>
-      <!-- <site name='tip'  pos='.15 0 .11'/>-->
-      <body name="bthigh" pos="-.5 0 0">
-        <joint axis="0 1 0" damping="6" name="bthigh" pos="0 0 0" range="-.52 1.05" stiffness="240" type="hinge"/>
-        <geom axisangle="0 1 0 -3.8" name="bthigh" pos=".1 0 -.13" size="0.046 .145" type="capsule"/>
-        <body name="bshin" pos=".16 0 -.25">
-          <joint axis="0 1 0" damping="4.5" name="bshin" pos="0 0 0" range="-.785 .785" stiffness="180" type="hinge"/>
-          <geom axisangle="0 1 0 -2.03" name="bshin" pos="-.14 0 -.07" rgba="0.9 0.6 0.6 1" size="0.046 .15" type="capsule"/>
-          <body name="bfoot" pos="-.28 0 -.14">
-            <joint axis="0 1 0" damping="3" name="bfoot" pos="0 0 0" range="-.4 .785" stiffness="120" type="hinge"/>
-            <geom axisangle="0 1 0 -.27" name="bfoot" pos=".03 0 -.097" rgba="0.9 0.6 0.6 1" size="0.046 .094" type="capsule"/>
-          </body>
-        </body>
-      </body>
-      <body name="fthigh" pos=".5 0 0">
-        <joint axis="0 1 0" damping="4.5" name="fthigh" pos="0 0 0" range="-1 .7" stiffness="180" type="hinge"/>
-        <geom axisangle="0 1 0 .52" name="fthigh" pos="-.07 0 -.12" size="0.046 .133" type="capsule"/>
-        <body name="fshin" pos="-.14 0 -.24">
-          <joint axis="0 1 0" damping="3" name="fshin" pos="0 0 0" range="-1.2 .87" stiffness="120" type="hinge"/>
-          <geom axisangle="0 1 0 -.6" name="fshin" pos=".065 0 -.09" rgba="0.9 0.6 0.6 1" size="0.046 .106" type="capsule"/>
-          <body name="ffoot" pos=".13 0 -.18">
-            <joint axis="0 1 0" damping="1.5" name="ffoot" pos="0 0 0" range="-.5 .5" stiffness="60" type="hinge"/>
-            <geom axisangle="0 1 0 -.6" name="ffoot" pos=".045 0 -.07" rgba="0.9 0.6 0.6 1" size="0.046 .07" type="capsule"/>
-          </body>
-        </body>
-      </body>
-    </body>
-  </worldbody>
-  <actuator>
-    <motor gear="120" joint="bthigh" name="bthigh"/>
-    <motor gear="90" joint="bshin" name="bshin"/>
-    <motor gear="60" joint="bfoot" name="bfoot"/>
-    <motor gear="120" joint="fthigh" name="fthigh"/>
-    <motor gear="60" joint="fshin" name="fshin"/>
-    <motor gear="30" joint="ffoot" name="ffoot"/>
-  </actuator>
-</mujoco>
\ No newline at end of file
diff --git a/diffuser/environments/assets/hopper.xml b/diffuser/environments/assets/hopper.xml
deleted file mode 100644
index 5b08bb6..0000000
--- a/diffuser/environments/assets/hopper.xml
+++ /dev/null
@@ -1,49 +0,0 @@
-<mujoco model="hopper">
-  <compiler angle="degree" coordinate="global" inertiafromgeom="true"/>
-  <default>
-    <joint armature="1" damping="1" limited="true"/>
-    <geom conaffinity="1" condim="1" contype="1" margin="0.001" material="geom" rgba="0.8 0.6 .4 1" solimp=".8 .8 .01" solref=".02 1"/>
-    <motor ctrllimited="true" ctrlrange="-.4 .4"/>
-  </default>
-  <option integrator="RK4" timestep="0.002"/>
-  <visual>
-    <map znear="0.02"/>
-  </visual>
-  <worldbody>
-    <light cutoff="100" diffuse="1 1 1" dir="-0 0 -1.3" directional="true" exponent="1" pos="0 0 1.3" specular=".1 .1 .1"/>
-    <geom conaffinity="1" condim="3" name="floor" pos="0 0 0" rgba="1 1 1 0" size="20 20 .125" type="plane"/>
-    <!-- <geom conaffinity="1" condim="3" name="floor" pos="0 0 0" rgba="1 1 1 1" size="20 20 .125" type="plane" material="MatPlane"/> -->
-    <body name="torso" pos="0 0 1.25">
-      <camera name="track" mode="trackcom" pos="0 -3 1" xyaxes="1 0 0 0 0 1"/>
-      <joint armature="0" axis="1 0 0" damping="0" limited="false" name="rootx" pos="0 0 0" stiffness="0" type="slide"/>
-      <joint armature="0" axis="0 0 1" damping="0" limited="false" name="rootz" pos="0 0 0" ref="1.25" stiffness="0" type="slide"/>
-      <joint armature="0" axis="0 1 0" damping="0" limited="false" name="rooty" pos="0 0 1.25" stiffness="0" type="hinge"/>
-      <geom friction="0.9" fromto="0 0 1.45 0 0 1.05" name="torso_geom" size="0.05" type="capsule"/>
-      <body name="thigh" pos="0 0 1.05">
-        <joint axis="0 -1 0" name="thigh_joint" pos="0 0 1.05" range="-150 0" type="hinge"/>
-        <geom friction="0.9" fromto="0 0 1.05 0 0 0.6" name="thigh_geom" size="0.05" type="capsule"/>
-        <body name="leg" pos="0 0 0.35">
-          <joint axis="0 -1 0" name="leg_joint" pos="0 0 0.6" range="-150 0" type="hinge"/>
-          <geom friction="0.9" fromto="0 0 0.6 0 0 0.1" name="leg_geom" size="0.04" type="capsule"/>
-          <body name="foot" pos="0.13/2 0 0.1">
-            <joint axis="0 -1 0" name="foot_joint" pos="0 0 0.1" range="-45 45" type="hinge"/>
-            <geom friction="2.0" fromto="-0.13 0 0.1 0.26 0 0.1" name="foot_geom" size="0.06" type="capsule"/>
-          </body>
-        </body>
-      </body>
-    </body>
-  </worldbody>
-  <actuator>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="200.0" joint="thigh_joint"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="200.0" joint="leg_joint"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="200.0" joint="foot_joint"/>
-  </actuator>
-    <asset>
-        <texture type="skybox" builtin="gradient" rgb1="1 1 1" rgb2="1 1 1"
-            width="100" height="100"/>
-        <texture builtin="flat" height="1278" mark="cross" markrgb="1 1 1" name="texgeom" random="0.01" rgb1="0.8 0.6 0.4" rgb2="0.8 0.6 0.4" type="cube" width="127"/>
-        <texture builtin="checker" height="100" name="texplane" rgb1="1 1 1" rgb2="1 1 1" type="2d" width="100"/>
-        <material name="MatPlane" reflectance="0.5" shininess="1" specular="1" texrepeat="60 60" texture="texplane"/>
-        <material name="geom" texture="texgeom" texuniform="true"/>
-    </asset>
-</mujoco>
\ No newline at end of file
diff --git a/diffuser/environments/assets/walker2d.xml b/diffuser/environments/assets/walker2d.xml
deleted file mode 100644
index 79947e7..0000000
--- a/diffuser/environments/assets/walker2d.xml
+++ /dev/null
@@ -1,62 +0,0 @@
-<mujoco model="walker2d">
-  <compiler angle="degree" coordinate="global" inertiafromgeom="true"/>
-  <default>
-    <joint armature="0.01" damping=".1" limited="true"/>
-    <geom conaffinity="0" condim="3" contype="1" density="1000" friction=".7 .1 .1" rgba="0.8 0.6 .4 1"/>
-  </default>
-  <option integrator="RK4" timestep="0.002"/>
-  <worldbody>
-    <light cutoff="100" diffuse="1 1 1" dir="-0 0 -1.3" directional="true" exponent="1" pos="0 0 1.3" specular=".1 .1 .1"/>
-    <geom conaffinity="1" condim="3" name="floor" pos="0 0 0" rgba="0.8 0.9 0.8 0" size="40 40 40" type="plane" material="MatPlane"/>
-    <body name="torso" pos="0 0 1.25">
-      <camera name="track" mode="trackcom" pos="0 -3 1" xyaxes="1 0 0 0 0 1"/>
-      <joint armature="0" axis="1 0 0" damping="0" limited="false" name="rootx" pos="0 0 0" stiffness="0" type="slide"/>
-      <joint armature="0" axis="0 0 1" damping="0" limited="false" name="rootz" pos="0 0 0" ref="1.25" stiffness="0" type="slide"/>
-      <joint armature="0" axis="0 1 0" damping="0" limited="false" name="rooty" pos="0 0 1.25" stiffness="0" type="hinge"/>
-      <geom friction="0.9" fromto="0 0 1.45 0 0 1.05" name="torso_geom" size="0.05" type="capsule"/>
-      <body name="thigh" pos="0 0 1.05">
-        <joint axis="0 -1 0" name="thigh_joint" pos="0 0 1.05" range="-150 0" type="hinge"/>
-        <geom friction="0.9" fromto="0 0 1.05 0 0 0.6" name="thigh_geom" size="0.05" type="capsule"/>
-        <body name="leg" pos="0 0 0.35">
-          <joint axis="0 -1 0" name="leg_joint" pos="0 0 0.6" range="-150 0" type="hinge"/>
-          <geom friction="0.9" fromto="0 0 0.6 0 0 0.1" name="leg_geom" size="0.04" type="capsule"/>
-          <body name="foot" pos="0.2/2 0 0.1">
-            <joint axis="0 -1 0" name="foot_joint" pos="0 0 0.1" range="-45 45" type="hinge"/>
-            <geom friction="0.9" fromto="-0.0 0 0.1 0.2 0 0.1" name="foot_geom" size="0.06" type="capsule"/>
-          </body>
-        </body>
-      </body>
-      <!-- copied and then replace thigh->thigh_left, leg->leg_left, foot->foot_right -->
-      <body name="thigh_left" pos="0 0 1.05">
-        <joint axis="0 -1 0" name="thigh_left_joint" pos="0 0 1.05" range="-150 0" type="hinge"/>
-        <geom friction="0.9" fromto="0 0 1.05 0 0 0.6" name="thigh_left_geom" rgba=".7 .3 .6 1" size="0.05" type="capsule"/>
-        <body name="leg_left" pos="0 0 0.35">
-          <joint axis="0 -1 0" name="leg_left_joint" pos="0 0 0.6" range="-150 0" type="hinge"/>
-          <geom friction="0.9" fromto="0 0 0.6 0 0 0.1" name="leg_left_geom" rgba=".7 .3 .6 1" size="0.04" type="capsule"/>
-          <body name="foot_left" pos="0.2/2 0 0.1">
-            <joint axis="0 -1 0" name="foot_left_joint" pos="0 0 0.1" range="-45 45" type="hinge"/>
-            <geom friction="1.9" fromto="-0.0 0 0.1 0.2 0 0.1" name="foot_left_geom" rgba=".7 .3 .6 1" size="0.06" type="capsule"/>
-          </body>
-        </body>
-      </body>
-    </body>
-  </worldbody>
-  <actuator>
-    <!-- <motor joint="torso_joint" ctrlrange="-100.0 100.0" isctrllimited="true"/>-->
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="100" joint="thigh_joint"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="100" joint="leg_joint"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="100" joint="foot_joint"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="100" joint="thigh_left_joint"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="100" joint="leg_left_joint"/>
-    <motor ctrllimited="true" ctrlrange="-1.0 1.0" gear="100" joint="foot_left_joint"/>
-    <!-- <motor joint="finger2_rot" ctrlrange="-20.0 20.0" isctrllimited="true"/>-->
-  </actuator>
-    <asset>
-        <texture type="skybox" builtin="gradient" rgb1="1 1 1" rgb2="1 1 1"
-            width="100" height="100"/>
-        <texture builtin="flat" height="1278" mark="cross" markrgb="1 1 1" name="texgeom" random="0.01" rgb1="0.8 0.6 0.4" rgb2="0.8 0.6 0.4" type="cube" width="127"/>
-        <texture builtin="checker" height="100" name="texplane" rgb1="0 0 0" rgb2="0.8 0.8 0.8" type="2d" width="100"/>
-        <material name="MatPlane" reflectance="0.5" shininess="1" specular="1" texrepeat="60 60" texture="texplane"/>
-        <material name="geom" texture="texgeom" texuniform="true"/>
-    </asset>
-</mujoco>
\ No newline at end of file
diff --git a/diffuser/environments/half_cheetah.py b/diffuser/environments/half_cheetah.py
deleted file mode 100644
index 1e02877..0000000
--- a/diffuser/environments/half_cheetah.py
+++ /dev/null
@@ -1,45 +0,0 @@
-import os
-import numpy as np
-from gym import utils
-from gym.envs.mujoco import mujoco_env
-
-class HalfCheetahFullObsEnv(mujoco_env.MujocoEnv, utils.EzPickle):
-    def __init__(self):
-        asset_path = os.path.join(
-            os.path.dirname(__file__), 'assets/half_cheetah.xml')
-        mujoco_env.MujocoEnv.__init__(self, asset_path, 5)
-        utils.EzPickle.__init__(self)
-
-    def step(self, action):
-        xposbefore = self.sim.data.qpos[0]
-        self.do_simulation(action, self.frame_skip)
-        xposafter = self.sim.data.qpos[0]
-        ob = self._get_obs()
-        reward_ctrl = - 0.1 * np.square(action).sum()
-        reward_run = (xposafter - xposbefore)/self.dt
-        reward = reward_ctrl + reward_run
-        done = False
-        return ob, reward, done, dict(reward_run=reward_run, reward_ctrl=reward_ctrl)
-
-    def _get_obs(self):
-        return np.concatenate([
-            # self.sim.data.qpos.flat[1:],
-            self.sim.data.qpos.flat, #[1:],
-            self.sim.data.qvel.flat,
-        ])
-
-    def reset_model(self):
-        qpos = self.init_qpos + self.np_random.uniform(low=-.1, high=.1, size=self.model.nq)
-        qvel = self.init_qvel + self.np_random.randn(self.model.nv) * .1
-        self.set_state(qpos, qvel)
-        return self._get_obs()
-
-    def viewer_setup(self):
-        self.viewer.cam.distance = self.model.stat.extent * 0.5
-
-    def set(self, state):
-        qpos_dim = self.sim.data.qpos.size
-        qpos = state[:qpos_dim]
-        qvel = state[qpos_dim:]
-        self.set_state(qpos, qvel)
-        return self._get_obs()
diff --git a/diffuser/environments/hopper.py b/diffuser/environments/hopper.py
deleted file mode 100644
index 90aba17..0000000
--- a/diffuser/environments/hopper.py
+++ /dev/null
@@ -1,51 +0,0 @@
-import os
-import numpy as np
-from gym import utils
-from gym.envs.mujoco import mujoco_env
-
-class HopperFullObsEnv(mujoco_env.MujocoEnv, utils.EzPickle):
-    def __init__(self):
-        asset_path = os.path.join(
-            os.path.dirname(__file__), 'assets/hopper.xml')
-        mujoco_env.MujocoEnv.__init__(self, asset_path, 4)
-        utils.EzPickle.__init__(self)
-
-    def step(self, a):
-        posbefore = self.sim.data.qpos[0]
-        self.do_simulation(a, self.frame_skip)
-        posafter, height, ang = self.sim.data.qpos[0:3]
-        alive_bonus = 1.0
-        reward = (posafter - posbefore) / self.dt
-        reward += alive_bonus
-        reward -= 1e-3 * np.square(a).sum()
-        s = self.state_vector()
-        done = not (np.isfinite(s).all() and (np.abs(s[2:]) < 100).all() and
-                    (height > .7) and (abs(ang) < .2))
-        ob = self._get_obs()
-        return ob, reward, done, {}
-
-    def _get_obs(self):
-        return np.concatenate([
-            # self.sim.data.qpos.flat[1:],
-            self.sim.data.qpos.flat,
-            np.clip(self.sim.data.qvel.flat, -10, 10)
-        ])
-
-    def reset_model(self):
-        qpos = self.init_qpos + self.np_random.uniform(low=-.005, high=.005, size=self.model.nq)
-        qvel = self.init_qvel + self.np_random.uniform(low=-.005, high=.005, size=self.model.nv)
-        self.set_state(qpos, qvel)
-        return self._get_obs()
-
-    def viewer_setup(self):
-        self.viewer.cam.trackbodyid = 2
-        self.viewer.cam.distance = self.model.stat.extent * 0.75
-        self.viewer.cam.lookat[2] = 1.15
-        self.viewer.cam.elevation = -20
-
-    def set(self, state):
-        qpos_dim = self.sim.data.qpos.size
-        qpos = state[:qpos_dim]
-        qvel = state[qpos_dim:]
-        self.set_state(qpos, qvel)
-        return self._get_obs()
\ No newline at end of file
diff --git a/diffuser/environments/registration.py b/diffuser/environments/registration.py
deleted file mode 100644
index 655a6f0..0000000
--- a/diffuser/environments/registration.py
+++ /dev/null
@@ -1,34 +0,0 @@
-import gym
-
-ENVIRONMENT_SPECS = (
-    {
-        'id': 'HopperFullObs-v2',
-        'entry_point': ('diffuser.environments.hopper:HopperFullObsEnv'),
-    },
-    {
-        'id': 'HalfCheetahFullObs-v2',
-        'entry_point': ('diffuser.environments.half_cheetah:HalfCheetahFullObsEnv'),
-    },
-    {
-        'id': 'Walker2dFullObs-v2',
-        'entry_point': ('diffuser.environments.walker2d:Walker2dFullObsEnv'),
-    },
-    {
-        'id': 'AntFullObs-v2',
-        'entry_point': ('diffuser.environments.ant:AntFullObsEnv'),
-    },
-)
-
-def register_environments():
-    try:
-        for environment in ENVIRONMENT_SPECS:
-            gym.register(**environment)
-
-        gym_ids = tuple(
-            environment_spec['id']
-            for environment_spec in  ENVIRONMENT_SPECS)
-
-        return gym_ids
-    except:
-        print('[ diffuser/environments/registration ] WARNING: not registering diffuser environments')
-        return tuple()
\ No newline at end of file
diff --git a/diffuser/environments/walker2d.py b/diffuser/environments/walker2d.py
deleted file mode 100644
index b0dadc6..0000000
--- a/diffuser/environments/walker2d.py
+++ /dev/null
@@ -1,43 +0,0 @@
-import os
-import numpy as np
-from gym import utils
-from gym.envs.mujoco import mujoco_env
-
-class Walker2dFullObsEnv(mujoco_env.MujocoEnv, utils.EzPickle):
-
-    def __init__(self):
-        asset_path = os.path.join(
-            os.path.dirname(__file__), 'assets/walker2d.xml')
-        mujoco_env.MujocoEnv.__init__(self, asset_path, 4)
-        utils.EzPickle.__init__(self)
-
-    def step(self, a):
-        posbefore = self.sim.data.qpos[0]
-        self.do_simulation(a, self.frame_skip)
-        posafter, height, ang = self.sim.data.qpos[0:3]
-        alive_bonus = 1.0
-        reward = ((posafter - posbefore) / self.dt)
-        reward += alive_bonus
-        reward -= 1e-3 * np.square(a).sum()
-        done = not (height > 0.8 and height < 2.0 and
-                    ang > -1.0 and ang < 1.0)
-        ob = self._get_obs()
-        return ob, reward, done, {}
-
-    def _get_obs(self):
-        qpos = self.sim.data.qpos
-        qvel = self.sim.data.qvel
-        return np.concatenate([qpos, qvel]).ravel()
-
-    def reset_model(self):
-        self.set_state(
-            self.init_qpos + self.np_random.uniform(low=-.005, high=.005, size=self.model.nq),
-            self.init_qvel + self.np_random.uniform(low=-.005, high=.005, size=self.model.nv)
-        )
-        return self._get_obs()
-
-    def viewer_setup(self):
-        self.viewer.cam.trackbodyid = 2
-        self.viewer.cam.distance = self.model.stat.extent * 0.5
-        self.viewer.cam.lookat[2] = 1.15
-        self.viewer.cam.elevation = -20